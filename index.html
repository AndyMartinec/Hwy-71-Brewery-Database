<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üç∫ Highway 71 Brewery COGS Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); overflow: hidden; }
        .header { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .tabs { display: flex; background: #34495e; overflow-x: auto; }
        .tab { padding: 15px 25px; color: white; cursor: pointer; border: none; background: transparent; font-size: 14px; font-weight: 500; white-space: nowrap; transition: background 0.3s; }
        .tab:hover { background: rgba(255,255,255,0.1); }
        .tab.active { background: white; color: #34495e; }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        th { background: #2c3e50; color: white; padding: 12px; text-align: left; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
        td { padding: 12px; border-bottom: 1px solid #ecf0f1; vertical-align: top; }
        tr:hover { background: #f8f9fa; }
        input, select, textarea { width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 14px; transition: border 0.3s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #3498db; }
        input[type="number"] { text-align: right; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; margin: 5px; }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3); }
        .btn-success { background: #27ae60; color: white; }
        .btn-success:hover { background: #229954; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        .btn-neutral { background: #7f8c8d; color: white; }
        .recipe-header { background: #ecf0f1; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .grid { display: grid; gap: 15px; }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
        .info-group { display: flex; flex-direction: column; }
        .info-group label { font-weight: 600; color: #2c3e50; margin-bottom: 5px; font-size: 13px; }
        .summary-box { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
        .summary-item { text-align: center; }
        .summary-label { font-size: 12px; opacity: 0.9; margin-bottom: 5px; }
        .summary-value { font-size: 24px; font-weight: bold; }
        .margin-good { color: #2ecc71; font-weight: bold; }
        .margin-ok { color: #f39c12; font-weight: bold; }
        .margin-poor { color: #e74c3c; font-weight: bold; }
        .actions { margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap; }
        .readonly { background: #f8f9fa; color: #666; }
        h2 { color: #2c3e50; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 3px solid #3498db; }
        .save-reminder { background: #fff3cd; border-left: 4px solid #f39c12; padding: 15px; margin: 20px 0; border-radius: 6px; }
        .save-reminder strong { color: #f39c12; }
        .muted { color: #6c757d; font-size: 13px; }
        .kpi { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
        .kpi div { background: #f6f9fc; border: 1px solid #e1e7ef; padding: 12px; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üç∫ Brewery COGS Tracker</h1>
            <p>Comprehensive Cost of Goods Sold Management System</p>
        </div>
        <div class="tabs">
            <button class="tab active" onclick="showTab('ingredients', this)">Ingredient Database</button>
            <button class="tab" onclick="showTab('recipes', this)">Recipes</button>
            <button class="tab" onclick="showTab('batches', this)">Batch Records</button>
            <!-- Updated tab name from Cost Analysis to Margin Analysis -->
            <button class="tab" onclick="showTab('analysis', this)">Margin Analysis</button>
        </div>

        <!-- INGREDIENTS TAB -->
        <div id="ingredients" class="tab-content active">
            <h2>Ingredient Database</h2>
            <div class="save-reminder">
                <strong>üíæ Important:</strong> Your data is automatically saved in your browser. Export regularly for backups.
            </div>
            <div class="actions">
                <button class="btn btn-primary" onclick="addIngredient()">+ Add Ingredient</button>
                <button class="btn btn-success" onclick="exportData()">üì• Export Data</button>
                <button class="btn btn-success" onclick="document.getElementById('importFile').click()">üì§ Import Data</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
            </div>
            <table id="ingredientTable">
                <thead>
                    <tr>
                        <th>Ingredient Name</th>
                        <th>Category</th>
                        <th>Unit</th>
                        <th>Cost per Unit ($)</th>
                        <th>Supplier</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="ingredientBody"></tbody>
            </table>
        </div>

        <!-- RECIPES TAB -->
        <div id="recipes" class="tab-content">
            <h2>Beer Recipes</h2>
            <div class="actions">
                <button class="btn btn-primary" onclick="addRecipe()">+ New Recipe</button>
                <select id="recipeSelector" onchange="loadRecipe()" style="width: 300px;">
                    <option value="">Select a recipe...</option>
                </select>
            </div>
            <div id="recipeEditor" style="display: none;">
                <div class="recipe-header">
                    <h3>Recipe Details</h3>
                    <div class="grid grid-3">
                        <div class="info-group">
                            <label>Beer Name</label>
                            <input type="text" id="recipeName" placeholder="e.g., Hazy IPA">
                        </div>
                        <div class="info-group">
                            <label>Style</label>
                            <input type="text" id="recipeStyle" placeholder="e.g., New England IPA">
                        </div>
                        <div class="info-group">
                            <label>Batch Size (bbls)</label>
                            <input type="number" id="batchSize" placeholder="e.g., 0.5" step="0.1">
                        </div>
                    </div>
                </div>
                <h3 style="margin-top: 30px;">Recipe Ingredients</h3>
                <div class="actions">
                    <button class="btn btn-success" onclick="addRecipeIngredient()">+ Add Ingredient</button>
                    <button class="btn btn-primary" onclick="saveRecipe()">üíæ Save Recipe</button>
                    <button class="btn btn-danger" onclick="deleteRecipe()">üóëÔ∏è Delete Recipe</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Ingredient</th>
                            <th>Category</th>
                            <th>Quantity</th>
                            <th>Unit</th>
                            <th>Cost/Unit</th>
                            <th>Total Cost</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="recipeIngredientsBody"></tbody>
                </table>
                <div class="summary-box">
                    <h3>Recipe Cost Summary</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">Total Recipe Cost</div>
                            <div class="summary-value" id="totalRecipeCost">$0.00</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Batch Size</div>
                            <div class="summary-value" id="displayBatchSize">0 bbl</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Cost per Barrel</div>
                            <div class="summary-value" id="costPerBarrel">$0.00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BATCHES TAB -->
        <div id="batches" class="tab-content">
            <h2>Batch Records</h2>
            <p class="muted">Track batch production, volume racked, and yield percentage for reporting.</p>
            <div class="recipe-header">
                <h3>New / Edit Batch</h3>
                <div class="grid grid-3">
                    <div class="info-group">
                        <label>Date Brewed</label>
                        <input type="date" id="batchDate">
                    </div>
                    <div class="info-group">
                        <label>Recipe</label>
                        <select id="batchRecipe" onchange="updateBatchKPIs()">
                            <option value="">Select recipe...</option>
                        </select>
                    </div>
                    <div class="info-group">
                        <label>Volume Racked (bbls)</label>
                        <input type="number" id="volumeRacked" step="0.01" placeholder="e.g., 6.3" oninput="updateBatchKPIs()">
                    </div>
                </div>
                <div class="actions">
                    <button class="btn btn-success" onclick="saveBatch()">üíæ Add / Update Batch</button>
                    <button class="btn btn-danger" onclick="clearBatchForm()">Clear Form</button>
                </div>
                <div class="kpi">
                    <div>
                        <div class="muted">Recipe Batch Size</div>
                        <div id="kpiRecipeBatchSize" class="summary-value">0.00 bbl</div>
                    </div>
                    <div>
                        <div class="muted">Yield % (Racked / Recipe Size)</div>
                        <div id="kpiYield" class="summary-value" style="color:#2ecc71">0%</div>
                    </div>
                    <!-- Added cost per BBL yielded KPI -->
                    <div>
                        <div class="muted">Cost per BBL Yielded</div>
                        <div id="kpiCostPerBBL" class="summary-value" style="color:#e67e22">$0.00</div>
                    </div>
                </div>
            </div>

            <h3>Recorded Batches</h3>
            <table>
                <thead>
                    <tr>
                        <th>Date Brewed</th>
                        <th>Recipe</th>
                        <th>Recipe Size (bbl)</th>
                        <th>Volume Racked (bbl)</th>
                        <th>Yield %</th>
                        <!-- Added cost per BBL yielded column -->
                        <th>Cost/BBL Yielded</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="batchTableBody"></tbody>
            </table>

            <h3>Monthly Volume Report</h3>
            <div class="actions">
                <label class="muted" for="monthPicker">Select Month/Year:</label>
                <input type="month" id="monthPicker" style="max-width:200px;">
                <button class="btn btn-primary" onclick="renderMonthlyCOGS()">Refresh</button>
            </div>
            <div class="kpi">
                <div>
                    <div class="muted">Total Volume Racked (bbl)</div>
                    <div id="mPackaged" class="summary-value" style="color:#3498db">0.00</div>
                </div>
                <div>
                    <div class="muted">Number of Batches</div>
                    <div id="mBatchCount" class="summary-value">0</div>
                </div>
                <div>
                    <div class="muted">Average Yield %</div>
                    <div id="mAvgYield" class="summary-value">0%</div>
                </div>
                <!-- Added average cost per BBL yielded in monthly report -->
                <div>
                    <div class="muted">Avg Cost per BBL Yielded</div>
                    <div id="mAvgCostPerBBL" class="summary-value" style="color:#e67e22">$0.00</div>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Date Brewed</th>
                        <th>Recipe</th>
                        <th>Recipe Size (bbl)</th>
                        <th>Volume Racked (bbl)</th>
                        <th>Yield %</th>
                        <!-- Added cost per BBL yielded in monthly table -->
                        <th>Cost/BBL Yielded</th>
                    </tr>
                </thead>
                <tbody id="monthlyTableBody"></tbody>
            </table>
        </div>

        <!-- ANALYSIS TAB -->
        <!-- Renamed to Margin Analysis and completely redesigned for sales tracking -->
        <div id="analysis" class="tab-content">
            <h2>Margin Analysis - Sales Tracking</h2>
            <p class="muted">Track sales by beer and unit size for a specific time period to calculate gross profit and margin.</p>
            
            <div class="recipe-header">
                <h3>Add Sales Entry</h3>
                <div class="grid grid-3">
                    <div class="info-group">
                        <label>Start Date</label>
                        <input type="date" id="salesStartDate">
                    </div>
                    <div class="info-group">
                        <label>End Date</label>
                        <input type="date" id="salesEndDate">
                    </div>
                    <div class="info-group">
                        <label>Recipe</label>
                        <select id="salesRecipe" onchange="updateSalesKPIs()">
                            <option value="">Select recipe...</option>
                        </select>
                    </div>
                </div>
                
                <h4 style="margin-top: 20px;">Units Sold & Pricing</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Size</th>
                            <th>Volume (oz)</th>
                            <th>Units Sold</th>
                            <th>Sale Price per Unit</th>
                            <th>Cost per Unit</th>
                            <th>Gross Profit</th>
                            <th>Margin %</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>16oz</td>
                            <td>16</td>
                            <td><input type="number" id="units16oz" value="0" min="0" step="1" oninput="updateSalesKPIs()"></td>
                            <td><input type="number" id="price16oz" value="0" min="0" step="0.01" oninput="updateSalesKPIs()"></td>
                            <td class="readonly" id="cost16oz">$0.00</td>
                            <td class="readonly" id="profit16oz">$0.00</td>
                            <td class="readonly" id="margin16oz">0%</td>
                        </tr>
                        <tr>
                            <td>10oz</td>
                            <td>10</td>
                            <td><input type="number" id="units10oz" value="0" min="0" step="1" oninput="updateSalesKPIs()"></td>
                            <td><input type="number" id="price10oz" value="0" min="0" step="0.01" oninput="updateSalesKPIs()"></td>
                            <td class="readonly" id="cost10oz">$0.00</td>
                            <td class="readonly" id="profit10oz">$0.00</td>
                            <td class="readonly" id="margin10oz">0%</td>
                        </tr>
                        <tr>
                            <td>Pitcher</td>
                            <td>64</td>
                            <td><input type="number" id="unitsPitcher" value="0" min="0" step="1" oninput="updateSalesKPIs()"></td>
                            <td><input type="number" id="pricePitcher" value="0" min="0" step="0.01" oninput="updateSalesKPIs()"></td>
                            <td class="readonly" id="costPitcher">$0.00</td>
                            <td class="readonly" id="profitPitcher">$0.00</td>
                            <td class="readonly" id="marginPitcher">0%</td>
                        </tr>
                        <tr>
                            <td>Growler</td>
                            <td>64</td>
                            <td><input type="number" id="unitsGrowler" value="0" min="0" step="1" oninput="updateSalesKPIs()"></td>
                            <td><input type="number" id="priceGrowler" value="0" min="0" step="0.01" oninput="updateSalesKPIs()"></td>
                            <td class="readonly" id="costGrowler">$0.00</td>
                            <td class="readonly" id="profitGrowler">$0.00</td>
                            <td class="readonly" id="marginGrowler">0%</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="summary-box">
                    <h3>Entry Totals</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">Total Units Sold</div>
                            <div class="summary-value" id="totalUnitsSold">0</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Total Revenue</div>
                            <div class="summary-value" id="totalRevenue">$0.00</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Total Cost</div>
                            <div class="summary-value" id="totalCost">$0.00</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Gross Profit</div>
                            <div class="summary-value" id="grossProfit">$0.00</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Gross Margin %</div>
                            <div class="summary-value" id="grossMargin">0%</div>
                        </div>
                    </div>
                </div>
                
                <div class="actions">
                    <button class="btn btn-success" onclick="saveSalesEntry()">üíæ Save Sales Entry</button>
                    <button class="btn btn-danger" onclick="clearSalesForm()">Clear Form</button>
                </div>
            </div>

            <h3>Sales Report</h3>
            <div class="actions">
                <label class="muted">Filter by Date Range:</label>
                <input type="date" id="reportStartDate" style="max-width:180px;">
                <input type="date" id="reportEndDate" style="max-width:180px;">
                <button class="btn btn-primary" onclick="renderSalesReport()">Refresh Report</button>
            </div>
            
            <div class="summary-box" style="margin-top: 20px;">
                <h3>Report Summary</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-label">Total Entries</div>
                        <div class="summary-value" id="reportEntries">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Total Units</div>
                        <div class="summary-value" id="reportUnits">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Total Revenue</div>
                        <div class="summary-value" id="reportRevenue">$0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Total Gross Profit</div>
                        <div class="summary-value" id="reportProfit">$0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Avg Margin %</div>
                        <div class="summary-value" id="reportMargin">0%</div>
                    </div>
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Date Range</th>
                        <th>Recipe</th>
                        <th>Size</th>
                        <th>Units Sold</th>
                        <th>Price/Unit</th>
                        <th>Revenue</th>
                        <th>Gross Profit</th>
                        <th>Margin %</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="salesReportBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // ======= APP STATE =======
        let ingredients = [];
        let recipes = [];
        let batches = [];
        let salesEntries = [];
        let currentRecipeId = null;
        let editingBatchId = null;
        let editingSalesId = null;

        // ======= STORAGE =======
        function loadFromStorage() {
            const savedIngredients = localStorage.getItem('breweryIngredients');
            const savedRecipes = localStorage.getItem('breweryRecipes');
            const savedBatches = localStorage.getItem('breweryBatches');
            const savedSales = localStorage.getItem('brewerySalesEntries');
            if (savedIngredients) ingredients = JSON.parse(savedIngredients);
            if (savedRecipes) recipes = JSON.parse(savedRecipes);
            if (savedBatches) batches = JSON.parse(savedBatches);
            if (savedSales) salesEntries = JSON.parse(savedSales);
            if (ingredients.length === 0 && recipes.length === 0) {
                initializeSampleData();
            } else {
                renderIngredients();
                updateRecipeSelectors();
            }
            updateBatchRecipeSelector();
            updateSalesRecipeSelector();
            renderBatches();
            setDefaultMonthPicker();
            renderMonthlyCOGS();
            renderSalesReport();
        }

        function saveToStorage() {
            try {
                localStorage.setItem('breweryIngredients', JSON.stringify(ingredients));
                localStorage.setItem('breweryRecipes', JSON.stringify(recipes));
                localStorage.setItem('breweryBatches', JSON.stringify(batches));
                localStorage.setItem('brewerySalesEntries', JSON.stringify(salesEntries));
            } catch (e) {
                console.log('localStorage not available');
            }
        }

        function exportData() {
            const data = { ingredients, recipes, batches, salesEntries, exportDate: new Date().toISOString() };
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `brewery-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            alert('Data exported successfully!');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.ingredients && data.recipes) {
                        if (confirm('This will replace all current data. Are you sure?')) {
                            ingredients = data.ingredients;
                            recipes = data.recipes;
                            batches = data.batches || [];
                            salesEntries = data.salesEntries || [];
                            saveToStorage();
                            renderIngredients();
                            updateRecipeSelectors();
                            updateBatchRecipeSelector();
                            updateSalesRecipeSelector();
                            renderBatches();
                            renderMonthlyCOGS();
                            renderSalesReport();
                            alert('Data imported successfully!');
                            document.getElementById('recipeSelector').value = '';
                            document.getElementById('recipeEditor').style.display = 'none';
                            currentRecipeId = null;
                        }
                    } else {
                        alert('Invalid data file format!');
                    }
                } catch (error) {
                    alert('Error reading file: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ======= SAMPLE DATA =======
        function initializeSampleData() {
            ingredients = [
                {id: 1, name: '2-Row Pale Malt', category: 'Malt', unit: 'lb', cost: 1.20, supplier: 'Briess'},
                {id: 2, name: 'Pilsner Malt', category: 'Malt', unit: 'lb', cost: 1.35, supplier: 'Weyermann'},
                {id: 3, name: 'Munich Malt', category: 'Malt', unit: 'lb', cost: 1.45, supplier: 'Briess'},
                {id: 4, name: 'Cascade Hops', category: 'Hops', unit: 'oz', cost: 2.50, supplier: 'Yakima'},
                {id: 5, name: 'Citra Hops', category: 'Hops', unit: 'oz', cost: 3.75, supplier: 'Yakima'},
                {id: 6, name: 'Mosaic Hops', category: 'Hops', unit: 'oz', cost: 3.50, supplier: 'Yakima'},
                {id: 7, name: 'US-05 Yeast', category: 'Yeast', unit: 'packet', cost: 4.50, supplier: 'Fermentis'},
                {id: 8, name: 'WLP001 California Ale', category: 'Yeast', unit: 'vial', cost: 8.00, supplier: 'White Labs'},
                {id: 9, name: 'Irish Moss', category: 'Other', unit: 'oz', cost: 1.25, supplier: 'Local'},
                {id: 10, name: 'Gypsum', category: 'Other', unit: 'oz', cost: 0.50, supplier: 'Local'}
            ];
            recipes = [{
                id: 1, name: 'West Coast IPA', style: 'American IPA', batchSize: 7,
                ingredients: [
                    {ingredientId: 1, quantity: 440}, {ingredientId: 4, quantity: 32},
                    {ingredientId: 5, quantity: 24}, {ingredientId: 7, quantity: 4}, {ingredientId: 9, quantity: 2}
                ],
                servingSizes: [
                    {name: 'Draft Pint', volume: 16, price: 7.00}, {name: 'Draft Half', volume: 8, price: 4.00},
                    {name: '12oz Can', volume: 12, price: 3.50}, {name: '16oz Can', volume: 16, price: 4.50}
                ]
            }];
            // Add sample sales data
            salesEntries = [
                {
                    id: 1678886400000, startDate: '2023-03-15', endDate: '2023-03-15', recipeId: 1, size: '16oz', sizeOz: 16,
                    units: 100, pricePerUnit: 4.50, costPerUnit: 1.25, revenue: 450.00, cost: 125.00, profit: 325.00, margin: 72.22
                },
                {
                    id: 1678972800000, startDate: '2023-03-16', endDate: '2023-03-16', recipeId: 1, size: '12oz Can', sizeOz: 12,
                    units: 150, pricePerUnit: 3.50, costPerUnit: 0.94, revenue: 525.00, cost: 140.63, profit: 384.38, margin: 73.22
                }
            ];
            saveToStorage();
            renderIngredients();
            updateRecipeSelectors();
            updateBatchRecipeSelector();
            updateSalesRecipeSelector();
            renderBatches();
            setDefaultMonthPicker();
            renderMonthlyCOGS();
            renderSalesReport();
        }

        // ======= TABS =======
        function showTab(tabName, el) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            const tab = document.getElementById(tabName);
            if (tab) tab.classList.add('active');
            if (el) el.classList.add('active');
        }

        // ======= INGREDIENTS =======
        function renderIngredients() {
            const tbody = document.getElementById('ingredientBody');
            tbody.innerHTML = '';
            ingredients.forEach(ing => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><input type="text" value="${ing.name}" onchange="updateIngredient(${ing.id}, 'name', this.value)"></td>
                    <td><select onchange="updateIngredient(${ing.id}, 'category', this.value)">
                        <option ${ing.category === 'Malt' ? 'selected' : ''}>Malt</option>
                        <option ${ing.category === 'Hops' ? 'selected' : ''}>Hops</option>
                        <option ${ing.category === 'Yeast' ? 'selected' : ''}>Yeast</option>
                        <option ${ing.category === 'Other' ? 'selected' : ''}>Other</option>
                    </select></td>
                    <td><input type="text" value="${ing.unit}" onchange="updateIngredient(${ing.id}, 'unit', this.value)"></td>
                    <td><input type="number" value="${Number(ing.cost).toFixed(2)}" step="0.01" onchange="updateIngredient(${ing.id}, 'cost', parseFloat(this.value) || 0)"></td>
                    <td><input type="text" value="${ing.supplier}" onchange="updateIngredient(${ing.id}, 'supplier', this.value)"></td>
                    <td><button class="btn btn-danger" onclick="deleteIngredient(${ing.id})">Delete</button></td>
                `;
            });
            saveToStorage();
        }

        function addIngredient() {
            const newId = ingredients.length > 0 ? Math.max(...ingredients.map(i => i.id)) + 1 : 1;
            ingredients.push({ id: newId, name: 'New Ingredient', category: 'Malt', unit: 'lb', cost: 0, supplier: '' });
            renderIngredients();
        }

        function updateIngredient(id, field, value) {
            const ing = ingredients.find(i => i.id === id);
            if (ing) {
                ing[field] = field === 'cost' ? (parseFloat(value) || 0) : value;
                saveToStorage();
                if (currentRecipeId) {
                    renderRecipeIngredients();
                    calculateRecipeCost();
                }
                // Update sales KPIs if ingredient cost changes
                updateSalesKPIs();
                renderSalesReport(); // Re-render to reflect potential changes in cost per unit
            }
        }

        function deleteIngredient(id) {
            if (!confirm('Are you sure?')) return;
            ingredients = ingredients.filter(i => i.id !== id);
            recipes.forEach(r => { r.ingredients = r.ingredients.filter(ri => ri.ingredientId !== id); });
            renderIngredients();
            if (currentRecipeId) { renderRecipeIngredients(); calculateRecipeCost(); }
            saveToStorage();
            // Update sales KPIs after ingredient deletion
            updateSalesKPIs();
            renderSalesReport();
        }

        // ======= RECIPES =======
        function addRecipe() {
            const newId = recipes.length > 0 ? Math.max(...recipes.map(r => r.id)) + 1 : 1;
            recipes.push({
                id: newId, name: 'New Recipe', style: '', batchSize: 1, ingredients: [],
                servingSizes: [
                    {name: 'Draft Pint', volume: 16, price: 7.00},
                    {name: 'Draft Half', volume: 8, price: 4.00},
                    {name: '12oz Can', volume: 12, price: 3.50},
                    {name: '16oz Can', volume: 16, price: 4.50}
                ]
            });
            saveToStorage();
            updateRecipeSelectors();
            updateBatchRecipeSelector();
            updateSalesRecipeSelector();
            document.getElementById('recipeSelector').value = newId;
            loadRecipe();
        }

        function updateRecipeSelectors() {
            const selector = document.getElementById('recipeSelector');
            if (!selector) return;
            const currentValue = selector.value;
            selector.innerHTML = '<option value="">Select a recipe...</option>';
            recipes.forEach(recipe => {
                const option = document.createElement('option');
                option.value = recipe.id;
                option.textContent = recipe.name;
                selector.appendChild(option);
            });
            selector.value = currentValue;
        }

        function loadRecipe() {
            const recipeId = parseInt(document.getElementById('recipeSelector').value);
            if (!recipeId) {
                document.getElementById('recipeEditor').style.display = 'none';
                return;
            }
            currentRecipeId = recipeId;
            const recipe = recipes.find(r => r.id === recipeId);
            document.getElementById('recipeName').value = recipe.name;
            document.getElementById('recipeStyle').value = recipe.style;
            document.getElementById('batchSize').value = recipe.batchSize;
            document.getElementById('recipeEditor').style.display = 'block';
            renderRecipeIngredients();
            calculateRecipeCost();
        }

        function renderRecipeIngredients() {
            const recipe = recipes.find(r => r.id === currentRecipeId);
            const tbody = document.getElementById('recipeIngredientsBody');
            tbody.innerHTML = '';
            recipe.ingredients.forEach((recIng, index) => {
                const ingredient = ingredients.find(i => i.id === recIng.ingredientId);
                if (!ingredient) return;
                const totalCost = (Number(recIng.quantity) * Number(ingredient.cost));
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><select onchange="updateRecipeIngredient(${index}, 'ingredientId', parseInt(this.value))">
                        ${ingredients.map(ing => `<option value="${ing.id}" ${ing.id === recIng.ingredientId ? 'selected' : ''}>${ing.name}</option>`).join('')}
                    </select></td>
                    <td class="readonly">${ingredient.category}</td>
                    <td><input type="number" value="${Number(recIng.quantity)}" step="0.1" onchange="updateRecipeIngredient(${index}, 'quantity', parseFloat(this.value) || 0)"></td>
                    <td class="readonly">${ingredient.unit}</td>
                    <td class="readonly">$${Number(ingredient.cost).toFixed(2)}</td>
                    <td class="readonly">$${totalCost.toFixed(2)}</td>
                    <td><button class="btn btn-danger" onclick="deleteRecipeIngredient(${index})">Delete</button></td>
                `;
            });
            saveToStorage();
        }

        function addRecipeIngredient() {
            const recipe = recipes.find(r => r.id === currentRecipeId);
            if (!recipe) return;
            if (ingredients.length === 0) { alert('Please add ingredients first!'); return; }
            recipe.ingredients.push({ ingredientId: ingredients[0].id, quantity: 1 });
            renderRecipeIngredients();
            calculateRecipeCost();
        }

        function updateRecipeIngredient(index, field, value) {
            const recipe = recipes.find(r => r.id === currentRecipeId);
            recipe.ingredients[index][field] = field === 'quantity' ? (parseFloat(value) || 0) : value;
            renderRecipeIngredients();
            calculateRecipeCost();
        }

        function deleteRecipeIngredient(index) {
            const recipe = recipes.find(r => r.id === currentRecipeId);
            recipe.ingredients.splice(index, 1);
            renderRecipeIngredients();
            calculateRecipeCost();
        }

        function calculateRecipeCost() {
            const recipe = recipes.find(r => r.id === currentRecipeId);
            if (!recipe) return;
            let totalCost = 0;
            recipe.ingredients.forEach(recIng => {
                const ingredient = ingredients.find(i => i.id === recIng.ingredientId);
                if (ingredient) totalCost += (Number(recIng.quantity) || 0) * (Number(ingredient.cost) || 0);
            });
            document.getElementById('totalRecipeCost').textContent = `$${totalCost.toFixed(2)}`;
            document.getElementById('displayBatchSize').textContent = `${Number(recipe.batchSize) || 0} bbl`;
            const costPerBbl = (Number(recipe.batchSize) > 0) ? totalCost / Number(recipe.batchSize) : 0;
            document.getElementById('costPerBarrel').textContent = `$${costPerBbl.toFixed(2)}`;
        }

        function saveRecipe() {
            const recipe = recipes.find(r => r.id === currentRecipeId);
            recipe.name = document.getElementById('recipeName').value;
            recipe.style = document.getElementById('recipeStyle').value;
            recipe.batchSize = parseFloat(document.getElementById('batchSize').value) || 0;
            saveToStorage();
            calculateRecipeCost();
            updateRecipeSelectors();
            updateBatchRecipeSelector();
            updateSalesRecipeSelector();
            alert('Recipe saved!');
        }

        function deleteRecipe() {
            if (confirm('Delete this recipe?')) {
                recipes = recipes.filter(r => r.id !== currentRecipeId);
                saveToStorage();
                updateRecipeSelectors();
                updateBatchRecipeSelector();
                updateSalesRecipeSelector();
                document.getElementById('recipeEditor').style.display = 'none';
                document.getElementById('recipeSelector').value = '';
                currentRecipeId = null;
                renderBatches();
                renderMonthlyCOGS();
                renderSalesReport(); // Re-render sales report as recipe might be used
            }
        }

        // ======= ANALYSIS - Removed old analysis code, replaced with sales tracking =======

        // ======= BATCHES =======
        function updateBatchRecipeSelector() {
            const sel = document.getElementById('batchRecipe');
            if (!sel) return;
            const current = sel.value;
            sel.innerHTML = '<option value="">Select recipe...</option>';
            recipes.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r.id;
                opt.textContent = r.name;
                sel.appendChild(opt);
            });
            sel.value = current;
        }

        function getBatchFormData() {
            const data = {
                id: editingBatchId || Date.now(),
                date: document.getElementById('batchDate').value,
                recipeId: parseInt(document.getElementById('batchRecipe').value) || null,
                volumeRacked: parseFloat(document.getElementById('volumeRacked').value) || 0
            };
            return data;
        }

        function getRecipeCost(recipeId) {
            const recipe = recipes.find(r => r.id === recipeId);
            if (!recipe) return 0;
            let totalCost = 0;
            recipe.ingredients.forEach(recIng => {
                const ingredient = ingredients.find(i => i.id === recIng.ingredientId);
                if (ingredient) totalCost += (Number(recIng.quantity) || 0) * (Number(ingredient.cost) || 0);
            });
            return totalCost;
        }

        function batchTotals(b) {
            const recipe = recipes.find(r => r.id === b.recipeId);
            const recipeBatchSize = recipe ? (Number(recipe.batchSize) || 0) : 0;
            const yieldPct = recipeBatchSize > 0 ? (b.volumeRacked / recipeBatchSize) * 100 : 0;
            const recipeCost = getRecipeCost(b.recipeId);
            const costPerBBL = b.volumeRacked > 0 ? recipeCost / b.volumeRacked : 0;
            return { recipeBatchSize, yieldPct, costPerBBL };
        }

        function updateBatchKPIs() {
            const b = getBatchFormData();
            const totals = batchTotals(b);
            document.getElementById('kpiRecipeBatchSize').textContent = `${totals.recipeBatchSize.toFixed(2)} bbl`;
            document.getElementById('kpiYield').textContent = `${totals.yieldPct.toFixed(1)}%`;
            document.getElementById('kpiCostPerBBL').textContent = `$${totals.costPerBBL.toFixed(2)}`;
        }

        ['batchDate','batchRecipe','volumeRacked'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', updateBatchKPIs);
                el.addEventListener('change', updateBatchKPIs);
            }
        });


        function saveBatch() {
            const b = getBatchFormData();
            if (!b.date) { alert('Please select a date.'); return; }
            if (!b.recipeId) { alert('Please select a recipe.'); return; }
            if (!b.volumeRacked || b.volumeRacked <= 0) { alert('Please enter volume racked.'); return; }
            const idx = batches.findIndex(x => x.id === b.id);
            if (idx >= 0) { batches[idx] = b; } else { batches.push(b); }
            editingBatchId = null;
            saveToStorage();
            renderBatches();
            renderMonthlyCOGS();
            clearBatchForm();
            alert('Batch saved.');
        }

        function clearBatchForm() {
            editingBatchId = null;
            document.getElementById('batchDate').value = '';
            document.getElementById('batchRecipe').value = '';
            document.getElementById('volumeRacked').value = '';
            updateBatchKPIs();
        }

        function editBatch(id) {
            const b = batches.find(x => x.id === id);
            if (!b) return;
            editingBatchId = b.id;
            document.getElementById('batchDate').value = b.date;
            document.getElementById('batchRecipe').value = b.recipeId;
            document.getElementById('volumeRacked').value = b.volumeRacked;
            updateBatchKPIs();
            showTab('batches', document.querySelector('.tabs .tab:nth-child(3)'));
        }

        function deleteBatch(id) {
            if (!confirm('Delete this batch?')) return;
            batches = batches.filter(x => x.id !== id);
            saveToStorage();
            renderBatches();
            renderMonthlyCOGS();
        }

        function renderBatches() {
            const tbody = document.getElementById('batchTableBody');
            tbody.innerHTML = '';
            const sorted = [...batches].sort((a,b)=> (b.date||'').localeCompare(a.date||''));
            sorted.forEach(b => {
                const r = recipes.find(x => x.id === b.recipeId);
                const name = r ? r.name : '(deleted recipe)';
                const totals = batchTotals(b);
                const tr = tbody.insertRow();
                tr.innerHTML = `
                    <td>${b.date || ''}</td>
                    <td>${name}</td>
                    <td>${totals.recipeBatchSize.toFixed(2)}</td>
                    <td>${(b.volumeRacked||0).toFixed(2)}</td>
                    <td>${totals.yieldPct.toFixed(1)}%</td>
                    <td>$${totals.costPerBBL.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-primary" onclick="editBatch(${b.id})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteBatch(${b.id})">Delete</button>
                    </td>
                `;
            });
        }

        function setDefaultMonthPicker() {
            const mp = document.getElementById('monthPicker');
            if (!mp.value) {
                const d = new Date();
                const y = d.getFullYear();
                const m = String(d.getMonth()+1).padStart(2,'0');
                mp.value = `${y}-${m}`;
            }
        }

        function renderMonthlyCOGS() {
            const mp = document.getElementById('monthPicker');
            if (!mp.value) setDefaultMonthPicker();
            const [year, month] = mp.value.split('-').map(x=>parseInt(x));
            const tbody = document.getElementById('monthlyTableBody');
            tbody.innerHTML = '';
            let sumVolumeRacked = 0;
            let sumYieldPct = 0;
            let sumCostPerBBL = 0;
            let batchCount = 0;

            const filtered = batches.filter(b => {
                if (!b.date) return false;
                const d = new Date(b.date + 'T00:00:00');
                return (d.getFullYear() === year && (d.getMonth()+1) === month);
            }).sort((a,b)=> (a.date||'').localeCompare(b.date));

            filtered.forEach(b => {
                const totals = batchTotals(b);
                sumVolumeRacked += b.volumeRacked || 0;
                sumYieldPct += totals.yieldPct;
                sumCostPerBBL += totals.costPerBBL;
                batchCount++;
                const r = recipes.find(x => x.id === b.recipeId);
                const name = r ? r.name : '(deleted recipe)';
                const tr = tbody.insertRow();
                tr.innerHTML = `
                    <td>${b.date}</td>
                    <td>${name}</td>
                    <td>${totals.recipeBatchSize.toFixed(2)}</td>
                    <td>${(b.volumeRacked||0).toFixed(2)}</td>
                    <td>${totals.yieldPct.toFixed(1)}%</td>
                    <td>$${totals.costPerBBL.toFixed(2)}</td>
                `;
            });

            document.getElementById('mPackaged').textContent = (sumVolumeRacked || 0).toFixed(2);
            document.getElementById('mBatchCount').textContent = batchCount;
            const avgYield = batchCount > 0 ? (sumYieldPct / batchCount) : 0;
            document.getElementById('mAvgYield').textContent = `${avgYield.toFixed(1)}%`;
            const avgCostPerBBL = batchCount > 0 ? (sumCostPerBBL / batchCount) : 0;
            document.getElementById('mAvgCostPerBBL').textContent = `$${avgCostPerBBL.toFixed(2)}`;
        }

        // ======= SALES / MARGIN ANALYSIS =======

        function updateSalesRecipeSelector() {
            const sel = document.getElementById('salesRecipe');
            if (!sel) return;
            const current = sel.value;
            sel.innerHTML = '<option value="">Select recipe...</option>';
            recipes.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r.id;
                opt.textContent = r.name;
                sel.appendChild(opt);
            });
            sel.value = current;
        }

        function updateSalesKPIs() {
            const recipeId = parseInt(document.getElementById('salesRecipe').value);
            if (!recipeId) {
                // Clear all calculations if no recipe selected
                ['16oz', '10oz', 'Pitcher', 'Growler'].forEach(size => {
                    document.getElementById(`cost${size}`).textContent = '$0.00';
                    document.getElementById(`profit${size}`).textContent = '$0.00';
                    document.getElementById(`margin${size}`).textContent = '0%';
                });
                document.getElementById('totalUnitsSold').textContent = '0';
                document.getElementById('totalRevenue').textContent = '$0.00';
                document.getElementById('totalCost').textContent = '$0.00';
                document.getElementById('grossProfit').textContent = '$0.00';
                document.getElementById('grossMargin').textContent = '0%';
                return;
            }

            const recipe = recipes.find(r => r.id === recipeId);
            const recipeCost = getRecipeCost(recipeId);
            const batchSizeOz = (Number(recipe.batchSize) || 0) * 31 * 128; // Convert BBLs to oz

            let totalUnits = 0;
            let totalRevenue = 0;
            let totalCost = 0;

            const sizes = [
                { id: '16oz', oz: 16, name: '16oz' },
                { id: '10oz', oz: 10, name: '10oz' },
                { id: 'Pitcher', oz: 64, name: 'Pitcher' },
                { id: 'Growler', oz: 64, name: 'Growler' }
            ];

            sizes.forEach(size => {
                const unitsInput = document.getElementById(`units${size.id}`);
                const priceInput = document.getElementById(`price${size.id}`);
                const units = parseInt(unitsInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;

                const costPerUnit = batchSizeOz > 0 ? (recipeCost * size.oz) / batchSizeOz : 0;
                const revenue = units * price;
                const cost = units * costPerUnit;
                const profit = revenue - cost;
                const margin = revenue > 0 ? (profit / revenue) * 100 : 0;

                document.getElementById(`cost${size.id}`).textContent = `$${costPerUnit.toFixed(2)}`;
                document.getElementById(`profit${size.id}`).textContent = `$${profit.toFixed(2)}`;
                document.getElementById(`margin${size.id}`).textContent = `${margin.toFixed(1)}%`;

                totalUnits += units;
                totalRevenue += revenue;
                totalCost += cost;
            });

            const grossProfit = totalRevenue - totalCost;
            const grossMargin = totalRevenue > 0 ? (grossProfit / totalRevenue) * 100 : 0;

            document.getElementById('totalUnitsSold').textContent = totalUnits;
            document.getElementById('totalRevenue').textContent = `$${totalRevenue.toFixed(2)}`;
            document.getElementById('totalCost').textContent = `$${totalCost.toFixed(2)}`;
            document.getElementById('grossProfit').textContent = `$${grossProfit.toFixed(2)}`;
            document.getElementById('grossMargin').textContent = `${grossMargin.toFixed(1)}%`;
        }

        function saveSalesEntry() {
            const startDate = document.getElementById('salesStartDate').value;
            const endDate = document.getElementById('salesEndDate').value;
            const recipeId = parseInt(document.getElementById('salesRecipe').value);

            if (!startDate || !endDate) {
                alert('Please select start and end dates.');
                return;
            }
            if (!recipeId) {
                alert('Please select a recipe.');
                return;
            }

            const recipe = recipes.find(r => r.id === recipeId);
            const recipeCost = getRecipeCost(recipeId);
            const batchSizeOz = (Number(recipe.batchSize) || 0) * 31 * 128;

            const sizes = [
                { id: '16oz', oz: 16, name: '16oz' },
                { id: '10oz', oz: 10, name: '10oz' },
                { id: 'Pitcher', oz: 64, name: 'Pitcher' },
                { id: 'Growler', oz: 64, name: 'Growler' }
            ];

            let hasData = false;
            let tempSalesEntries = []; // To store entries for this save operation

            sizes.forEach(size => {
                const unitsInput = document.getElementById(`units${size.id}`);
                const priceInput = document.getElementById(`price${size.id}`);
                const units = parseInt(unitsInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;

                if (units > 0) {
                    hasData = true;
                    const costPerUnit = batchSizeOz > 0 ? (recipeCost * size.oz) / batchSizeOz : 0;
                    const revenue = units * price;
                    const cost = units * costPerUnit;
                    const profit = revenue - cost;
                    const margin = revenue > 0 ? (profit / revenue) * 100 : 0;

                    const entryId = editingSalesId || Date.now() + Math.random(); // Use existing ID or generate new
                    const entry = {
                        id: entryId,
                        startDate,
                        endDate,
                        recipeId,
                        size: size.name,
                        sizeOz: size.oz,
                        units,
                        pricePerUnit: price,
                        costPerUnit,
                        revenue,
                        cost,
                        profit,
                        margin
                    };
                    tempSalesEntries.push(entry);
                }
            });

            if (!hasData) {
                alert('Please enter at least one unit sold.');
                return;
            }

            // If editing, remove the old entry before adding new ones
            if (editingSalesId) {
                salesEntries = salesEntries.filter(e => e.id !== editingSalesId);
            }

            // Add the new entries
            salesEntries.push(...tempSalesEntries);

            saveToStorage();
            renderSalesReport();
            clearSalesForm();
            alert('Sales entry saved!');
        }

        function clearSalesForm() {
            editingSalesId = null; // Reset editing state
            document.getElementById('salesStartDate').value = '';
            document.getElementById('salesEndDate').value = '';
            document.getElementById('salesRecipe').value = '';
            ['16oz', '10oz', 'Pitcher', 'Growler'].forEach(size => {
                document.getElementById(`units${size}`).value = '0';
                document.getElementById(`price${size}`).value = '0';
            });
            updateSalesKPIs();
        }

        function deleteSalesEntry(id) {
            if (!confirm('Delete this sales entry?')) return;
            salesEntries = salesEntries.filter(e => e.id !== id);
            saveToStorage();
            renderSalesReport();
        }

        function renderSalesReport() {
            const startDateInput = document.getElementById('reportStartDate');
            const endDateInput = document.getElementById('reportEndDate');
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;

            let filtered = salesEntries;
            if (startDate && endDate) {
                filtered = salesEntries.filter(e => {
                    // Ensure date comparison is correct
                    return e.startDate >= startDate && e.endDate <= endDate;
                });
            } else if (startDate) {
                 filtered = salesEntries.filter(e => e.startDate >= startDate);
            } else if (endDate) {
                 filtered = salesEntries.filter(e => e.endDate <= endDate);
            }


            const tbody = document.getElementById('salesReportBody');
            tbody.innerHTML = '';

            let totalEntries = filtered.length;
            let totalUnits = 0;
            let totalRevenue = 0;
            let totalProfit = 0;

            // Sort by start date ascending for the report
            const sorted = [...filtered].sort((a, b) => (a.startDate || '').localeCompare(b.startDate || ''));

            sorted.forEach(entry => {
                const recipe = recipes.find(r => r.id === entry.recipeId);
                const recipeName = recipe ? recipe.name : '(deleted recipe)';
                
                totalUnits += entry.units;
                totalRevenue += entry.revenue;
                totalProfit += entry.profit;

                const tr = tbody.insertRow();
                tr.innerHTML = `
                    <td>${entry.startDate} to ${entry.endDate}</td>
                    <td>${recipeName}</td>
                    <td>${entry.size}</td>
                    <td>${entry.units}</td>
                    <td>$${entry.pricePerUnit.toFixed(2)}</td>
                    <td>$${entry.revenue.toFixed(2)}</td>
                    <td>$${entry.profit.toFixed(2)}</td>
                    <td>${entry.margin.toFixed(1)}%</td>
                    <td>
                        <button class="btn btn-primary" onclick="editSalesEntry(${entry.id})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteSalesEntry(${entry.id})">Delete</button>
                    </td>
                `;
            });

            const avgMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;

            document.getElementById('reportEntries').textContent = totalEntries;
            document.getElementById('reportUnits').textContent = totalUnits;
            document.getElementById('reportRevenue').textContent = `$${totalRevenue.toFixed(2)}`;
            document.getElementById('reportProfit').textContent = `$${totalProfit.toFixed(2)}`;
            document.getElementById('reportMargin').textContent = `${avgMargin.toFixed(1)}%`;
        }

        // Added edit function for sales entries
        function editSalesEntry(id) {
            const entry = salesEntries.find(e => e.id === id);
            if (!entry) return;

            editingSalesId = entry.id; // Set the ID for editing
            document.getElementById('salesStartDate').value = entry.startDate;
            document.getElementById('salesEndDate').value = entry.endDate;
            document.getElementById('salesRecipe').value = entry.recipeId;
            
            // Populate the size-specific fields
            const sizes = [
                { id: '16oz', oz: 16, name: '16oz' },
                { id: '10oz', oz: 10, name: '10oz' },
                { id: 'Pitcher', oz: 64, name: 'Pitcher' },
                { id: 'Growler', oz: 64, name: 'Growler' }
            ];

            sizes.forEach(size => {
                if (entry.size === size.name) {
                    document.getElementById(`units${size.id}`).value = entry.units;
                    document.getElementById(`price${size.id}`).value = entry.pricePerUnit.toFixed(2);
                } else {
                    // Clear other size inputs if this entry was only for one size
                    document.getElementById(`units${size.id}`).value = '0';
                    document.getElementById(`price${size.id}`).value = '0';
                }
            });

            updateSalesKPIs(); // Recalculate KPIs based on loaded data
            showTab('analysis', document.querySelector('.tabs .tab:nth-child(4)')); // Switch to the analysis tab
        }


        // ======= INIT =======
        (function initDefaults(){
            const batchDateEl = document.getElementById('batchDate');
            if (batchDateEl && !batchDateEl.value) {
                const d = new Date();
                batchDateEl.value = d.toISOString().slice(0,10);
            }
            const salesStart = document.getElementById('salesStartDate');
            const salesEnd = document.getElementById('salesEndDate');
            if (salesStart && !salesStart.value) {
                const d = new Date();
                salesStart.value = d.toISOString().slice(0,10);
            }
            if (salesEnd && !salesEnd.value) {
                const d = new Date();
                salesEnd.value = d.toISOString().slice(0,10);
            }
        })();

        loadFromStorage();
    </script>
</body>
</html>
