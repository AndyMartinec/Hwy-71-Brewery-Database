<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Highway 71 Brewery COGS Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #e1e6ec;
            min-height: 100vh; 
            padding: 0;
        }
        .container { 
            max-width: 1600px; 
            margin: 0 auto; 
            background: white; 
            min-height: 100vh;
            box-shadow: 0 0 40px rgba(0,0,0,0.08); 
        }
        /* Professional brick red header with logo */
        .header { 
            background: linear-gradient(135deg, #9B3528 0%, #B24236 100%); 
            color: white; 
            padding: 24px 40px; 
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .header-logo {
            height: 60px;
            width: auto;
        }
        .header-content {
            flex: 1;
        }
        .header h1 { 
            font-size: 1.75em; 
            margin-bottom: 4px; 
            font-weight: 600;
            letter-spacing: -0.5px;
        }
        .header p {
            font-size: 0.9em;
            opacity: 0.95;
            font-weight: 400;
        }
        /* </CHANGE> */
        
        /* Professional neutral tabs */
        .tabs { 
            display: flex; 
            background: linear-gradient(to bottom, #dce4ec, #d1dce7); 
            border-bottom: 2px solid #b8c5d6;
            overflow-x: auto; 
            padding: 0 40px;
            box-shadow: inset 0 -2px 4px rgba(0,0,0,0.05);
        }
        .tab { 
            padding: 16px 24px; 
            color: #495057; 
            cursor: pointer; 
            border: none; 
            background: transparent; 
            font-size: 14px; 
            font-weight: 600; 
            white-space: nowrap; 
            transition: all 0.2s; 
            border-bottom: 3px solid transparent;
            position: relative;
            top: 2px;
        }
        .tab:hover { 
            color: #9B3528;
            background: rgba(155, 53, 40, 0.05);
        }
        .tab.active { 
            color: #9B3528; 
            background: white;
            border-bottom-color: #9B3528;
        }
        /* </CHANGE> */
        
        .tab-content { display: none; padding: 40px; background: white; }
        .tab-content.active { display: block; }
        
        /* Professional table styling */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 24px 0; 
            background: white; 
            border: 1px solid #c8d4e3;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        th { 
            background: linear-gradient(135deg, #6b7f96 0%, #7a8fa6 100%); 
            color: white; 
            padding: 14px 16px; 
            text-align: left; 
            font-weight: 600; 
            font-size: 13px; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        /* </CHANGE> */
        
        td { 
            padding: 14px 16px; 
            border-bottom: 1px solid #e3e9f0; 
            vertical-align: middle; 
            font-size: 14px;
        }
        tr:last-child td {
            border-bottom: none;
        }
        /* Updated table row hover with grey-blue tint */
        tr:hover { background: #f4f7fb; }
        /* </CHANGE> */
        
        /* Professional input styling */
        input, select, textarea { 
            width: 100%; 
            padding: 10px 12px; 
            border: 1px solid #c8d4e3; 
            border-radius: 6px; 
            font-size: 14px; 
            transition: all 0.2s;
            background: white;
            font-family: inherit;
        }
        input:focus, select:focus, textarea:focus { 
            outline: none; 
            border-color: #7a8fa6; 
            box-shadow: 0 0 0 3px rgba(122, 143, 166, 0.15);
        }
        /* </CHANGE> */
        
        /* All money-related values now in green */
        input[type="number"] { text-align: right; color: #28a745; font-weight: 600; }
        input[type="number"].non-currency { color: #495057; font-weight: 500; }
        /* </CHANGE> */
        
        /* Professional button styling with neutral tones */
        .btn { 
            padding: 10px 18px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 600; 
            transition: all 0.2s; 
            margin: 5px 5px 5px 0;
            font-family: inherit;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn-primary { 
            background: #9B3528; 
            color: white; 
        }
        .btn-primary:hover { 
            background: #8a2f23;
        }
        .btn-success { 
            background: #28a745; 
            color: white; 
        }
        .btn-success:hover { 
            background: #218838; 
        }
        .btn-danger { 
            background: #6c757d; 
            color: white; 
        }
        .btn-danger:hover { 
            background: #5a6268; 
        }
        .btn-neutral { 
            background: #e9ecef; 
            color: #495057; 
        }
        .btn-neutral:hover {
            background: #dee2e6;
        }
        /* </CHANGE> */
        
        /* CSV modal styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { 
            background: white; 
            margin: 5% auto; 
            padding: 32px; 
            border-radius: 12px; 
            width: 90%; 
            max-width: 900px; 
            max-height: 80vh; 
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        /* Updated modal header with grey-blue border */
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 24px; 
            padding-bottom: 16px; 
            border-bottom: 2px solid #c8d4e3; 
        }
        /* </CHANGE> */
        
        .modal-header h2 { 
            color: #212529; 
            margin: 0;
            font-size: 1.5em;
            font-weight: 600;
        }
        .close { 
            color: #6c757d; 
            font-size: 32px; 
            font-weight: 300; 
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s;
        }
        .close:hover { color: #212529; }
        /* Updated CSV preview with grey-blue styling */
        .csv-preview { 
            background: linear-gradient(to bottom, #f4f7fb, #eaf0f7); 
            padding: 16px; 
            border-radius: 8px; 
            margin: 16px 0; 
            overflow-x: auto;
            border: 1px solid #c8d4e3;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        /* </CHANGE> */
        
        .csv-preview table { margin: 0; font-size: 12px; border: none; }
        .csv-preview th, .csv-preview td { padding: 8px; }
        .mapping-section { margin: 24px 0; }
        /* Updated mapping rows with grey-blue background */
        .mapping-row { 
            display: grid; 
            grid-template-columns: 1fr auto 1fr; 
            gap: 16px; 
            align-items: center; 
            margin-bottom: 16px; 
            padding: 16px; 
            background: linear-gradient(to right, #f4f7fb, #eaf0f7); 
            border-radius: 8px;
            border: 1px solid #d1dce7;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        /* </CHANGE> */
        
        .mapping-arrow { 
            font-size: 20px; 
            color: #9B3528;
            font-weight: bold;
        }
        
        /* Updated info boxes */
        .info-box { 
            background: linear-gradient(to right, #e8f4ff, #d9edff); 
            border-left: 4px solid #0066cc; 
            padding: 16px; 
            margin: 16px 0; 
            border-radius: 6px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .info-box strong { color: #0052a3; }
        .update-summary { 
            background: linear-gradient(to right, #fff8e6, #ffedcc); 
            border-left: 4px solid: #f39c12; 
            padding: 16px; 
            margin: 16px 0; 
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        /* </CHANGE> */
        
        /* Updated recipe header with grey-blue gradient and depth */
        .recipe-header { 
            background: linear-gradient(135deg, #eaf0f7 0%, #dce8f3 100%); 
            padding: 24px; 
            border-radius: 8px; 
            margin-bottom: 24px;
            border: 1px solid #c8d4e3;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }
        /* </CHANGE> */
        
        .recipe-header h3 {
            color: #212529;
            font-size: 1.1em;
            margin-bottom: 16px;
            font-weight: 600;
        }
        
        .grid { display: grid; gap: 16px; }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
        
        .info-group { display: flex; flex-direction: column; }
        .info-group label { 
            font-weight: 600; 
            color: #495057; 
            margin-bottom: 6px; 
            font-size: 13px; 
        }
        
        /* Updated summary box with grey-blue gradient */
        .summary-box { 
            background: linear-gradient(135deg, #6b7f96 0%, #7a8fa6 100%); 
            color: white; 
            padding: 24px; 
            border-radius: 8px; 
            margin: 24px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        /* </CHANGE> */
        
        .summary-box h3 {
            margin-bottom: 16px;
            font-size: 1.2em;
            font-weight: 600;
        }
        
        .summary-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); 
            gap: 16px; 
            margin-top: 16px; 
        }
        .summary-item { text-align: center; }
        .summary-label { 
            font-size: 12px; 
            opacity: 0.9; 
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Money values now in green */
        .summary-value { 
            font-size: 26px; 
            font-weight: bold; 
            color: #7bed9f;
        }
        /* </CHANGE> */
        
        .margin-good { color: #7bed9f; font-weight: bold; }
        .margin-ok { color: #ffd93d; font-weight: bold; }
        .margin-poor { color: #ff6b9d; font-weight: bold; }
        
        .actions { margin: 24px 0; display: flex; gap: 8px; flex-wrap: wrap; }
        
        /* Updated readonly fields with grey-blue background and green text for money */
        .readonly { 
            background: linear-gradient(to bottom, #f4f7fb, #eaf0f7); 
            color: #28a745; 
            cursor: not-allowed; 
            font-weight: 600;
            border: 1px solid #d1dce7;
        }
        /* </CHANGE> */
        
        /* Professional section headings */
        h2 { 
            color: #212529; 
            margin-bottom: 24px; 
            padding-bottom: 12px; 
            border-bottom: 3px solid #9B3528;
            font-size: 1.5em;
            font-weight: 600;
        }
        h3 {
            color: #212529;
            font-size: 1.2em;
            margin: 20px 0 16px 0;
            font-weight: 600;
        }
        h4 {
            color: #495057;
            font-size: 1em;
            margin: 16px 0 12px 0;
            font-weight: 600;
        }
        /* </CHANGE> */
        
        /* Updated save reminder with grey-blue tones */
        .save-reminder { 
            background: linear-gradient(to right, #fff8e6, #ffedcc); 
            border-left: 4px solid #f39c12; 
            padding: 16px; 
            margin: 20px 0; 
            border-radius: 6px;
            font-size: 14px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        /* </CHANGE> */
        
        .save-reminder strong { color: #f39c12; }
        
        .muted { 
            color: #6c757d; 
            font-size: 13px; 
        }
        
        /* Professional KPI cards */
        .kpi { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 16px;
            margin: 20px 0;
        }
        .kpi div { 
            background: linear-gradient(135deg, #eaf0f7 0%, #dce8f3 100%); 
            border: 1px solid #c8d4e3; 
            padding: 16px; 
            border-radius: 8px;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }
        .kpi div:hover {
            border-color: #9B3528;
            box-shadow: 0 4px 12px rgba(155, 53, 40, 0.15);
            transform: translateY(-2px);
        }
        .kpi .muted {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: block;
        }
        .kpi .summary-value {
            font-size: 22px;
            color: #28a745;
        }
        /* </CHANGE> */
    </style>
</head>
<body>
    <div class="container">
        <!-- Added logo to header -->
        <div class="header">
            <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/hwy71logo-mrB0r5K2pUyejDfZ5spqR5QUndqNAN.avif" alt="Highway 71 Brewery" class="header-logo">
            <div class="header-content">
                <h1>Brewery COGS Tracker</h1>
                <p>Comprehensive Cost of Goods Sold Management System</p>
            </div>
        </div>
        <!-- </CHANGE> -->
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('ingredients', this)">Ingredient Database</button>
            <button class="tab" onclick="showTab('recipes', this)">Recipes</button>
            <button class="tab" onclick="showTab('batches', this)">Batch Records</button>
            <button class="tab" onclick="showTab('analysis', this)">Margin Analysis</button>
        </div>

        <!-- INGREDIENTS TAB -->
        <div id="ingredients" class="tab-content active">
            <h2>Ingredient Database</h2>
            <div class="save-reminder">
                <strong>üíæ Important:</strong> Your data is automatically saved in your browser. Export regularly for backups.
            </div>
            <div class="actions">
                <button class="btn btn-primary" onclick="addIngredient()">+ Add Ingredient</button>
                <!-- Added CSV upload button for price sheets -->
                <button class="btn btn-primary" onclick="document.getElementById('csvUploadFile').click()">üìã Upload Price Sheet (CSV)</button>
                <input type="file" id="csvUploadFile" accept=".csv" style="display: none;" onchange="handleCSVUpload(event)">
                <!-- </CHANGE> -->
                <button class="btn btn-success" onclick="exportData()">üì• Export Data</button>
                <button class="btn btn-success" onclick="document.getElementById('importFile').click()">üì§ Import Data</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
            </div>
            <table id="ingredientTable">
                <thead>
                    <tr>
                        <th>Ingredient Name</th>
                        <th>Category</th>
                        <th>Unit</th>
                        <th>Cost per Unit ($)</th>
                        <th>Supplier</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="ingredientBody"></tbody>
            </table>
        </div>

        <!-- RECIPES TAB -->
        <div id="recipes" class="tab-content">
            <h2>Beer Recipes</h2>
            <div class="actions">
                <button class="btn btn-primary" onclick="addRecipe()">+ New Recipe</button>
                <select id="recipeSelector" onchange="loadRecipe()" style="width: 300px;">
                    <option value="">Select a recipe...</option>
                </select>
            </div>
            <div id="recipeEditor" style="display: none;">
                <div class="recipe-header">
                    <h3>Recipe Details</h3>
                    <div class="grid grid-3">
                        <div class="info-group">
                            <label>Beer Name</label>
                            <input type="text" id="recipeName" placeholder="e.g., Hazy IPA">
                        </div>
                        <div class="info-group">
                            <label>Style</label>
                            <input type="text" id="recipeStyle" placeholder="e.g., New England IPA">
                        </div>
                        <div class="info-group">
                            <label>Batch Size (bbls)</label>
                            <input type="number" id="batchSize" class="non-currency" placeholder="e.g., 0.5" step="0.1">
                        </div>
                    </div>
                </div>
                <h3 style="margin-top: 30px;">Recipe Ingredients</h3>
                <div class="actions">
                    <button class="btn btn-success" onclick="addRecipeIngredient()">+ Add Ingredient</button>
                    <button class="btn btn-primary" onclick="saveRecipe()">üíæ Save Recipe</button>
                    <button class="btn btn-danger" onclick="deleteRecipe()">üóëÔ∏è Delete Recipe</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Ingredient</th>
                            <th>Category</th>
                            <th>Quantity</th>
                            <th>Unit</th>
                            <th>Cost/Unit</th>
                            <th>Total Cost</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="recipeIngredientsBody"></tbody>
                </table>
                <div class="summary-box">
                    <h3>Recipe Cost Summary</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">Total Recipe Cost</div>
                            <div class="summary-value" id="totalRecipeCost">$0.00</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Batch Size</div>
                            <div class="summary-value" id="displayBatchSize">0 bbl</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Cost per Barrel</div>
                            <div class="summary-value" id="costPerBarrel">$0.00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BATCHES TAB -->
        <div id="batches" class="tab-content">
            <h2>Batch Records</h2>
            <p class="muted">Track batch production, volume racked, and yield percentage for reporting.</p>
            <div class="recipe-header">
                <h3>New / Edit Batch</h3>
                <div class="grid grid-3">
                    <div class="info-group">
                        <label>Date Brewed</label>
                        <input type="date" id="batchDate">
                    </div>
                    <div class="info-group">
                        <label>Recipe</label>
                        <select id="batchRecipe" onchange="updateBatchKPIs()">
                            <option value="">Select recipe...</option>
                        </select>
                    </div>
                    <div class="info-group">
                        <label>Volume Racked (bbls)</label>
                        <input type="number" id="volumeRacked" class="non-currency" step="0.01" placeholder="e.g., 6.3" oninput="updateBatchKPIs()">
                    </div>
                </div>
                <div class="actions">
                    <button class="btn btn-success" onclick="saveBatch()">üíæ Add / Update Batch</button>
                    <button class="btn btn-danger" onclick="clearBatchForm()">Clear Form</button>
                </div>
                <div class="kpi">
                    <div>
                        <span class="muted">Recipe Batch Size</span>
                        <div id="kpiRecipeBatchSize" class="summary-value">0.00 bbl</div>
                    </div>
                    <div>
                        <span class="muted">Yield % (Racked / Recipe Size)</span>
                        <div id="kpiYield" class="summary-value" style="color:#28a745">0%</div>
                    </div>
                    <div>
                        <span class="muted">Cost per BBL Yielded</span>
                        <div id="kpiCostPerBBL" class="summary-value" style="color:#28a745">$0.00</div>
                    </div>
                </div>
            </div>

            <h3>Recorded Batches</h3>
            <table>
                <thead>
                    <tr>
                        <th>Date Brewed</th>
                        <th>Recipe</th>
                        <th>Recipe Size (bbl)</th>
                        <th>Volume Racked (bbl)</th>
                        <th>Yield %</th>
                        <th>Cost/BBL Yielded</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="batchTableBody"></tbody>
            </table>

            <h3>Monthly Volume Report</h3>
            <div class="actions">
                <label class="muted" for="monthPicker">Select Month/Year:</label>
                <input type="month" id="monthPicker" style="max-width:200px;">
                <button class="btn btn-primary" onclick="renderMonthlyCOGS()">Refresh</button>
            </div>
            <div class="kpi">
                <div>
                    <span class="muted">Total Volume Racked (bbl)</span>
                    <div id="mPackaged" class="summary-value" style="color:#28a745">0.00</div>
                </div>
                <div>
                    <span class="muted">Number of Batches</span>
                    <div id="mBatchCount" class="summary-value">0</div>
                </div>
                <div>
                    <span class="muted">Average Yield %</span>
                    <div id="mAvgYield" class="summary-value">0%</div>
                </div>
                <div>
                    <span class="muted">Avg Cost per BBL Yielded</span>
                    <div id="mAvgCostPerBBL" class="summary-value" style="color:#28a745">$0.00</div>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Date Brewed</th>
                        <th>Recipe</th>
                        <th>Recipe Size (bbl)</th>
                        <th>Volume Racked (bbl)</th>
                        <th>Yield %</th>
                        <th>Cost/BBL Yielded</th>
                    </tr>
                </thead>
                <tbody id="monthlyTableBody"></tbody>
            </table>
        </div>

        <!-- ANALYSIS TAB -->
        <div id="analysis" class="tab-content">
            <h2>Margin Analysis - Sales Tracking</h2>
            <p class="muted">Track sales by beer and unit size for a specific time period to calculate gross profit and margin.</p>
            
            <div class="recipe-header">
                <h3>Add Sales Entry</h3>
                <div class="grid grid-3">
                    <div class="info-group">
                        <label>Start Date</label>
                        <input type="date" id="salesStartDate">
                    </div>
                    <div class="info-group">
                        <label>End Date</label>
                        <input type="date" id="salesEndDate">
                    </div>
                    <div class="info-group">
                        <label>Recipe</label>
                        <select id="salesRecipe" onchange="updateSalesKPIs()">
                            <option value="">Select recipe...</option>
                        </select>
                    </div>
                </div>
                
                <h4 style="margin-top: 20px;">Units Sold & Pricing</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Size</th>
                            <th>Volume (oz)</th>
                            <th>Units Sold</th>
                            <th>Sale Price per Unit</th>
                            <th>Cost per Unit</th>
                            <th>Gross Profit</th>
                            <th>Margin %</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>16oz</td>
                            <td>16</td>
                            <td><input type="number" id="units16oz" class="non-currency" value="0" min="0" step="1" oninput="updateSalesKPIs()"></td>
                            <td><input type="number" id="price16oz" value="0" min="0" step="0.01" oninput="updateSalesKPIs()"></td>
                            <td class="readonly" id="cost16oz">$0.00</td>
                            <td class="readonly" id="profit16oz">$0.00</td>
                            <td class="readonly" id="margin16oz">0%</td>
                        </tr>
                        <tr>
                            <td>10oz</td>
                            <td>10</td>
                            <td><input type="number" id="units10oz" class="non-currency" value="0" min="0" step="1" oninput="updateSalesKPIs()"></td>
                            <td><input type="number" id="price10oz" value="0" min="0" step="0.01" oninput="updateSalesKPIs()"></td>
                            <td class="readonly" id="cost10oz">$0.00</td>
                            <td class="readonly" id="profit10oz">$0.00</td>
                            <td class="readonly" id="margin10oz">0%</td>
                        </tr>
                        <tr>
                            <td>Pitcher</td>
                            <td>64</td>
                            <td><input type="number" id="unitsPitcher" class="non-currency" value="0" min="0" step="1" oninput="updateSalesKPIs()"></td>
                            <td><input type="number" id="pricePitcher" value="0" min="0" step="0.01" oninput="updateSalesKPIs()"></td>
                            <td class="readonly" id="costPitcher">$0.00</td>
                            <td class="readonly" id="profitPitcher">$0.00</td>
                            <td class="readonly" id="marginPitcher">0%</td>
                        </tr>
                        <tr>
                            <td>Growler</td>
                            <td>64</td>
                            <td><input type="number" id="unitsGrowler" class="non-currency" value="0" min="0" step="1" oninput="updateSalesKPIs()"></td>
                            <td><input type="number" id="priceGrowler" value="0" min="0" step="0.01" oninput="updateSalesKPIs()"></td>
                            <td class="readonly" id="costGrowler">$0.00</td>
                            <td class="readonly" id="profitGrowler">$0.00</td>
                            <td class="readonly" id="marginGrowler">0%</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="summary-box">
                    <h3>Entry Totals</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">Total Units Sold</div>
                            <div class="summary-value" id="totalUnitsSold">0</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Total Revenue</div>
                            <div class="summary-value" id="totalRevenue">$0.00</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Total Cost</div>
                            <div class="summary-value" id="totalCost">$0.00</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Gross Profit</div>
                            <div class="summary-value" id="grossProfit">$0.00</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Gross Margin %</div>
                            <div class="summary-value" id="grossMargin">0%</div>
                        </div>
                    </div>
                </div>
                
                <div class="actions">
                    <button class="btn btn-success" onclick="saveSalesEntry()">üíæ Save Sales Entry</button>
                    <button class="btn btn-danger" onclick="clearSalesForm()">Clear Form</button>
                </div>
            </div>

            <h3>Sales Report</h3>
            <div class="actions">
                <label class="muted">Filter by Date Range:</label>
                <input type="date" id="reportStartDate" style="max-width:180px;">
                <input type="date" id="reportEndDate" style="max-width:180px;">
                <button class="btn btn-primary" onclick="renderSalesReport()">Refresh Report</button>
            </div>
            
            <div class="summary-box" style="margin-top: 20px;">
                <h3>Report Summary</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-label">Total Entries</div>
                        <div class="summary-value" id="reportEntries">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Total Units</div>
                        <div class="summary-value" id="reportUnits">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Total Revenue</div>
                        <div class="summary-value" id="reportRevenue">$0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Total Gross Profit</div>
                        <div class="summary-value" id="reportProfit">$0.00</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Avg Margin %</div>
                        <div class="summary-value" id="reportMargin">0%</div>
                    </div>
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Date Range</th>
                        <th>Recipe</th>
                        <th>Size</th>
                        <th>Units Sold</th>
                        <th>Price/Unit</th>
                        <th>Revenue</th>
                        <th>Gross Profit</th>
                        <th>Margin %</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="salesReportBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Added CSV upload modal for price sheet mapping -->
    <div id="csvModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Import Price Sheet</h2>
                <span class="close" onclick="closeCSVModal()">&times;</span>
            </div>
            
            <div class="info-box">
                <strong>üìã How it works:</strong> Upload a CSV file with your supplier's price sheet. 
                We'll match the columns to your ingredient data and update pricing automatically.
            </div>
            
            <div id="csvPreviewSection" style="display: none;">
                <h3>CSV Preview (first 5 rows)</h3>
                <div class="csv-preview">
                    <table id="csvPreviewTable"></table>
                </div>
                
                <h3>Column Mapping</h3>
                <p class="muted">Map the CSV columns to your ingredient fields:</p>
                <div class="mapping-section" id="columnMapping"></div>
                
                <div class="update-summary" id="updateSummary" style="display: none;"></div>
                
                <div class="actions">
                    <button class="btn btn-success" onclick="applyCSVImport()">‚úì Apply Updates</button>
                    <button class="btn btn-neutral" onclick="closeCSVModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    <!-- </CHANGE> -->

    <script>
        // ======= APP STATE =======
        let ingredients = [];
        let recipes = [];
        let batches = [];
        let salesEntries = [];
        let currentRecipeId = null;
        let editingBatchId = null;
        let editingSalesId = null;
        let csvData = null;
        let csvMapping = {
            name: null,
            category: null,
            unit: null,
            cost: null,
            supplier: null
        };
        // </CHANGE>

        // ======= STORAGE =======
        function loadFromStorage() {
            const savedIngredients = localStorage.getItem('breweryIngredients');
            const savedRecipes = localStorage.getItem('breweryRecipes');
            const savedBatches = localStorage.getItem('breweryBatches');
            const savedSales = localStorage.getItem('brewerySalesEntries');
            if (savedIngredients) ingredients = JSON.parse(savedIngredients);
            if (savedRecipes) recipes = JSON.parse(savedRecipes);
            if (savedBatches) batches = JSON.parse(savedBatches);
            if (savedSales) salesEntries = JSON.parse(savedSales);
            if (ingredients.length === 0 && recipes.length === 0) {
                initializeSampleData();
            } else {
                renderIngredients();
                updateRecipeSelectors();
            }
            updateBatchRecipeSelector();
            updateSalesRecipeSelector();
            renderBatches();
            setDefaultMonthPicker();
            renderMonthlyCOGS();
            renderSalesReport();
        }

        function saveToStorage() {
            try {
                localStorage.setItem('breweryIngredients', JSON.stringify(ingredients));
                localStorage.setItem('breweryRecipes', JSON.stringify(recipes));
                localStorage.setItem('breweryBatches', JSON.stringify(batches));
                localStorage.setItem('brewerySalesEntries', JSON.stringify(salesEntries));
            } catch (e) {
                console.log('localStorage not available');
            }
        }

        function exportData() {
            const data = { ingredients, recipes, batches, salesEntries, exportDate: new Date().toISOString() };
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `brewery-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            alert('Data exported successfully!');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.ingredients && data.recipes) {
                        if (confirm('This will replace all current data. Are you sure?')) {
                            ingredients = data.ingredients;
                            recipes = data.recipes;
                            batches = data.batches || [];
                            salesEntries = data.salesEntries || [];
                            saveToStorage();
                            renderIngredients();
                            updateRecipeSelectors();
                            updateBatchRecipeSelector();
                            updateSalesRecipeSelector();
                            renderBatches();
                            renderMonthlyCOGS();
                            renderSalesReport();
                            alert('Data imported successfully!');
                            document.getElementById('recipeSelector').value = '';
                            document.getElementById('recipeEditor').style.display = 'none';
                            currentRecipeId = null;
                        }
                    } else {
                        alert('Invalid data file format!');
                    }
                } catch (error) {
                    alert('Error reading file: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ======= SAMPLE DATA =======
        function initializeSampleData() {
            ingredients = [
                {id: 1, name: '2-Row Pale Malt', category: 'Malt', unit: 'lb', cost: 1.20, supplier: 'Briess'},
                {id: 2, name: 'Pilsner Malt', category: 'Malt', unit: 'lb', cost: 1.35, supplier: 'Weyermann'},
                {id: 3, name: 'Munich Malt', category: 'Malt', unit: 'lb', cost: 1.45, supplier: 'Briess'},
                {id: 4, name: 'Cascade Hops', category: 'Hops', unit: 'oz', cost: 2.50, supplier: 'Yakima'},
                {id: 5, name: 'Citra Hops', category: 'Hops', unit: 'oz', cost: 3.75, supplier: 'Yakima'},
                {id: 6, name: 'Mosaic Hops', category: 'Hops', unit: 'oz', cost: 3.50, supplier: 'Yakima'},
                {id: 7, name: 'US-05 Yeast', category: 'Yeast', unit: 'packet', cost: 4.50, supplier: 'Fermentis'},
                {id: 8, name: 'WLP001 California Ale', category: 'Yeast', unit: 'vial', cost: 8.00, supplier: 'White Labs'},
                {id: 9, name: 'Irish Moss', category: 'Other', unit: 'oz', cost: 1.25, supplier: 'Local'},
                {id: 10, name: 'Gypsum', category: 'Other', unit: 'oz', cost: 0.50, supplier: 'Local'}
            ];
            recipes = [{
                id: 1, name: 'West Coast IPA', style: 'American IPA', batchSize: 7,
                ingredients: [
                    {ingredientId: 1, quantity: 440}, {ingredientId: 4, quantity: 32},
                    {ingredientId: 5, quantity: 24}, {ingredientId: 7, quantity: 4}, {ingredientId: 9, quantity: 2}
                ],
                servingSizes: [
                    {name: 'Draft Pint', volume: 16, price: 7.00}, {name: 'Draft Half', volume: 8, price: 4.00},
                    {name: '12oz Can', volume: 12, price: 3.50}, {name: '16oz Can', volume: 16, price: 4.50}
                ]
            }];
            salesEntries = [
                {
                    id: 1678886400000, startDate: '2023-03-15', endDate: '2023-03-15', recipeId: 1, size: '16oz', sizeOz: 16,
                    units: 100, pricePerUnit: 4.50, costPerUnit: 1.25, revenue: 450.00, cost: 125.00, profit: 325.00, margin: 72.22
                },
                {
                    id: 1678972800000, startDate: '2023-03-16', endDate: '2023-03-16', recipeId: 1, size: '12oz Can', sizeOz: 12,
                    units: 150, pricePerUnit: 3.50, costPerUnit: 0.94, revenue: 525.00, cost: 140.63, profit: 384.38, margin: 73.22
                }
            ];
            saveToStorage();
            renderIngredients();
            updateRecipeSelectors();
            updateBatchRecipeSelector();
            updateSalesRecipeSelector();
            renderBatches();
            setDefaultMonthPicker();
            renderMonthlyCOGS();
            renderSalesReport();
        }

        // ======= TABS =======
        function showTab(tabName, el) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            const tab = document.getElementById(tabName);
            if (tab) tab.classList.add('active');
            if (el) el.classList.add('active');
        }

        // ======= INGREDIENTS =======
        function renderIngredients() {
            const tbody = document.getElementById('ingredientBody');
            tbody.innerHTML = '';
            ingredients.forEach(ing => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><input type="text" value="${ing.name}" onchange="updateIngredient(${ing.id}, 'name', this.value)"></td>
                    <td><select onchange="updateIngredient(${ing.id}, 'category', this.value)">
                        <option ${ing.category === 'Malt' ? 'selected' : ''}>Malt</option>
                        <option ${ing.category === 'Hops' ? 'selected' : ''}>Hops</option>
                        <option ${ing.category === 'Yeast' ? 'selected' : ''}>Yeast</option>
                        <option ${ing.category === 'Other' ? 'selected' : ''}>Other</option>
                    </select></td>
                    <td><input type="text" value="${ing.unit}" onchange="updateIngredient(${ing.id}, 'unit', this.value)"></td>
                    <td><input type="number" value="${Number(ing.cost).toFixed(2)}" step="0.01" onchange="updateIngredient(${ing.id}, 'cost', parseFloat(this.value) || 0)"></td>
                    <td><input type="text" value="${ing.supplier}" onchange="updateIngredient(${ing.id}, 'supplier', this.value)"></td>
                    <td><button class="btn btn-danger" onclick="deleteIngredient(${ing.id})">Delete</button></td>
                `;
            });
            saveToStorage();
        }

        function addIngredient() {
            const newId = ingredients.length > 0 ? Math.max(...ingredients.map(i => i.id)) + 1 : 1;
            ingredients.push({ id: newId, name: 'New Ingredient', category: 'Malt', unit: 'lb', cost: 0, supplier: '' });
            renderIngredients();
        }

        function updateIngredient(id, field, value) {
            const ing = ingredients.find(i => i.id === id);
            if (ing) {
                ing[field] = field === 'cost' ? (parseFloat(value) || 0) : value;
                saveToStorage();
                if (currentRecipeId) {
                    renderRecipeIngredients();
                    calculateRecipeCost();
                }
                updateSalesKPIs();
                renderSalesReport();
            }
        }

        function deleteIngredient(id) {
            if (!confirm('Are you sure?')) return;
            ingredients = ingredients.filter(i => i.id !== id);
            recipes.forEach(r => { r.ingredients = r.ingredients.filter(ri => ri.ingredientId !== id); });
            renderIngredients();
            if (currentRecipeId) { renderRecipeIngredients(); calculateRecipeCost(); }
            saveToStorage();
            updateSalesKPIs();
            renderSalesReport();
        }

        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    parseCSV(text);
                } catch (error) {
                    alert('Error reading CSV file: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function parseCSV(text) {
            const lines = text.split(/\r\n|\n/);
            if (lines.length < 2) {
                alert('CSV file must have at least a header row and one data row.');
                return;
            }
            
            // Parse CSV with proper quote handling
            const parseCSVLine = (line) => {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            };
            
            const headers = parseCSVLine(lines[0]);
            const rows = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = parseCSVLine(lines[i]);
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    rows.push(row);
                }
            }
            
            csvData = { headers, rows };
            showCSVPreview();
        }

        function showCSVPreview() {
            document.getElementById('csvModal').style.display = 'block';
            document.getElementById('csvPreviewSection').style.display = 'block';
            
            // Show preview table (first 5 rows)
            const previewTable = document.getElementById('csvPreviewTable');
            let html = '<thead><tr>';
            csvData.headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            csvData.rows.slice(0, 5).forEach(row => {
                html += '<tr>';
                csvData.headers.forEach(header => {
                    html += `<td>${row[header]}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody>';
            previewTable.innerHTML = html;
            
            // Create column mapping interface
            createColumnMapping();
            
            // Show update summary
            showUpdateSummary();
        }

        function createColumnMapping() {
            const mappingDiv = document.getElementById('columnMapping');
            const fields = [
                { key: 'name', label: 'Ingredient Name', required: true },
                { key: 'category', label: 'Category', required: false },
                { key: 'unit', label: 'Unit', required: false },
                { key: 'cost', label: 'Cost per Unit', required: true },
                { key: 'supplier', label: 'Supplier', required: false }
            ];
            
            mappingDiv.innerHTML = '';
            
            fields.forEach(field => {
                const row = document.createElement('div');
                row.className = 'mapping-row';
                
                // Auto-detect best match for each field
                let bestMatch = '';
                let bestScore = 0;
                csvData.headers.forEach(header => {
                    const headerLower = header.toLowerCase();
                    const fieldLower = field.label.toLowerCase();
                    
                    // Simple matching logic
                    if (headerLower.includes(fieldLower.split(' ')[0]) || 
                        fieldLower.includes(headerLower)) {
                        const score = headerLower.length;
                        if (score > bestScore || !bestMatch) {
                            bestMatch = header;
                            bestScore = score;
                        }
                    }
                    
                    // Specific matches
                    if (field.key === 'name' && (headerLower.includes('name') || headerLower.includes('ingredient') || headerLower.includes('item'))) {
                        bestMatch = header;
                    }
                    if (field.key === 'cost' && (headerLower.includes('cost') || headerLower.includes('price') || headerLower.includes('$'))) {
                        bestMatch = header;
                    }
                    if (field.key === 'unit' && headerLower.includes('unit')) {
                        bestMatch = header;
                    }
                    if (field.key === 'supplier' && headerLower.includes('supplier')) {
                        bestMatch = header;
                    }
                    if (field.key === 'category' && headerLower.includes('category')) {
                        bestMatch = header;
                    }
                });
                
                csvMapping[field.key] = bestMatch;
                
                row.innerHTML = `
                    <div>
                        <strong>${field.label}</strong> ${field.required ? '<span style="color: red;">*</span>' : ''}
                    </div>
                    <div class="mapping-arrow">‚Üí</div>
                    <div>
                        <select id="mapping_${field.key}" onchange="updateMapping('${field.key}', this.value)">
                            <option value="">-- Skip this field --</option>
                            ${csvData.headers.map(h => `<option value="${h}" ${h === bestMatch ? 'selected' : ''}>${h}</option>`).join('')}
                        </select>
                    </div>
                `;
                
                mappingDiv.appendChild(row);
            });
        }

        function updateMapping(field, value) {
            csvMapping[field] = value || null;
            showUpdateSummary();
        }

        function showUpdateSummary() {
            const summaryDiv = document.getElementById('updateSummary');
            
            if (!csvMapping.name || !csvMapping.cost) {
                summaryDiv.style.display = 'block';
                summaryDiv.innerHTML = '<strong>‚ö†Ô∏è Required Mapping:</strong> Please map at least "Ingredient Name" and "Cost per Unit" columns to proceed.';
                return;
            }
            
            // Analyze what will be updated
            let updateCount = 0;
            let newCount = 0;
            
            csvData.rows.forEach(row => {
                const name = row[csvMapping.name]?.trim();
                const costStr = row[csvMapping.cost]?.trim();
                
                if (!name || !costStr) return;
                
                const existing = ingredients.find(ing => 
                    ing.name.toLowerCase() === name.toLowerCase()
                );
                
                if (existing) {
                    updateCount++;
                } else {
                    newCount++;
                }
            });
            
            summaryDiv.style.display = 'block';
            summaryDiv.innerHTML = `
                <strong>üìä Import Summary:</strong><br>
                ‚Ä¢ ${updateCount} existing ingredient(s) will be updated with new pricing<br>
                ‚Ä¢ ${newCount} new ingredient(s) will be added to your database<br>
                ‚Ä¢ Total rows to process: ${csvData.rows.length}
            `;
        }

        function applyCSVImport() {
            if (!csvMapping.name || !csvMapping.cost) {
                alert('Please map at least Ingredient Name and Cost per Unit columns.');
                return;
            }
            
            let updateCount = 0;
            let newCount = 0;
            let errorCount = 0;
            
            csvData.rows.forEach(row => {
                try {
                    const name = row[csvMapping.name]?.trim();
                    const costStr = row[csvMapping.cost]?.trim().replace(/[$,]/g, '');
                    const cost = parseFloat(costStr);
                    
                    if (!name || isNaN(cost)) {
                        errorCount++;
                        return;
                    }
                    
                    // Try to find existing ingredient
                    let ingredient = ingredients.find(ing => 
                        ing.name.toLowerCase() === name.toLowerCase()
                    );
                    
                    if (ingredient) {
                        // Update existing
                        ingredient.cost = cost;
                        if (csvMapping.unit && row[csvMapping.unit]) {
                            ingredient.unit = row[csvMapping.unit].trim();
                        }
                        if (csvMapping.supplier && row[csvMapping.supplier]) {
                            ingredient.supplier = row[csvMapping.supplier].trim();
                        }
                        if (csvMapping.category && row[csvMapping.category]) {
                            ingredient.category = row[csvMapping.category].trim();
                        }
                        updateCount++;
                    } else {
                        // Create new ingredient
                        const newId = ingredients.length > 0 ? Math.max(...ingredients.map(i => i.id)) + 1 : 1;
                        const newIngredient = {
                            id: newId,
                            name: name,
                            category: (csvMapping.category && row[csvMapping.category]) ? row[csvMapping.category].trim() : 'Other',
                            unit: (csvMapping.unit && row[csvMapping.unit]) ? row[csvMapping.unit].trim() : 'lb',
                            cost: cost,
                            supplier: (csvMapping.supplier && row[csvMapping.supplier]) ? row[csvMapping.supplier].trim() : ''
                        };
                        ingredients.push(newIngredient);
                        newCount++;
                    }
                } catch (error) {
                    errorCount++;
                }
            });
            
            saveToStorage();
            renderIngredients();
            
            // Update all calculations
            if (currentRecipeId) {
                renderRecipeIngredients();
                calculateRecipeCost();
            }
            updateSalesKPIs();
            renderSalesReport();
            
            closeCSVModal();
            
            alert(`Import complete!\n\n‚úì ${updateCount} ingredients updated\n‚úì ${newCount} new ingredients added${errorCount > 0 ? `\n‚ö†Ô∏è ${errorCount} rows skipped (invalid data)` : ''}`);
        }

        function closeCSVModal() {
            document.getElementById('csvModal').style.display = 'none';
            document.getElementById('csvPreviewSection').style.display = 'none';
            csvData = null;
            csvMapping = { name: null, category: null, unit: null, cost: null, supplier: null };
        }
        // </CHANGE>

        // ======= RECIPES =======
        function addRecipe() {
            const newId = recipes.length > 0 ? Math.max(...recipes.map(r => r.id)) + 1 : 1;
            recipes.push({
                id: newId, name: 'New Recipe', style: '', batchSize: 1, ingredients: [],
                servingSizes: [
                    {name: 'Draft Pint', volume: 16, price: 7.00},
                    {name: 'Draft Half', volume: 8, price: 4.00},
                    {name: '12oz Can', volume: 12, price: 3.50},
                    {name: '16oz Can', volume: 16, price: 4.50}
                ]
            });
            saveToStorage();
            updateRecipeSelectors();
            updateBatchRecipeSelector();
            updateSalesRecipeSelector();
            document.getElementById('recipeSelector').value = newId;
            loadRecipe();
        }

        function updateRecipeSelectors() {
            const selector = document.getElementById('recipeSelector');
            if (!selector) return;
            const currentValue = selector.value;
            selector.innerHTML = '<option value="">Select a recipe...</option>';
            recipes.forEach(recipe => {
                const option = document.createElement('option');
                option.value = recipe.id;
                option.textContent = recipe.name;
                selector.appendChild(option);
            });
            selector.value = currentValue;
        }

        function loadRecipe() {
            const recipeId = parseInt(document.getElementById('recipeSelector').value);
            if (!recipeId) {
                document.getElementById('recipeEditor').style.display = 'none';
                return;
            }
            currentRecipeId = recipeId;
            const recipe = recipes.find(r => r.id === recipeId);
            document.getElementById('recipeName').value = recipe.name;
            document.getElementById('recipeStyle').value = recipe.style;
            document.getElementById('batchSize').value = recipe.batchSize;
            document.getElementById('recipeEditor').style.display = 'block';
            renderRecipeIngredients();
            calculateRecipeCost();
        }

        function renderRecipeIngredients() {
            const recipe = recipes.find(r => r.id === currentRecipeId);
            const tbody = document.getElementById('recipeIngredientsBody');
            tbody.innerHTML = '';
            recipe.ingredients.forEach((recIng, index) => {
                const ingredient = ingredients.find(i => i.id === recIng.ingredientId);
                if (!ingredient) return;
                const totalCost = (Number(recIng.quantity) * Number(ingredient.cost));
                
                // Group ingredients by supplier for dropdown
                const groupedIngredients = {};
                ingredients.forEach(ing => {
                    const supplier = ing.supplier || 'Unknown';
                    if (!groupedIngredients[supplier]) {
                        groupedIngredients[supplier] = [];
                    }
                    groupedIngredients[supplier].push(ing);
                });
                
                // Sort suppliers alphabetically
                const sortedSuppliers = Object.keys(groupedIngredients).sort();
                
                // Build grouped dropdown HTML
                let selectHTML = '<select onchange="updateRecipeIngredient(' + index + ', \'ingredientId\', parseInt(this.value))">';
                sortedSuppliers.forEach(supplier => {
                    selectHTML += '<optgroup label="' + supplier + '">';
                    groupedIngredients[supplier].forEach(ing => {
                        const selected = ing.id === recIng.ingredientId ? 'selected' : '';
                        selectHTML += '<option value="' + ing.id + '" ' + selected + '>' + ing.name + ' (' + supplier + ')</option>';
                    });
                    selectHTML += '</optgroup>';
                });
                selectHTML += '</select>';
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${selectHTML}</td>
                    <td class="readonly">${ingredient.category}</td>
                    <td><input type="number" class="non-currency" value="${Number(recIng.quantity)}" step="0.1" onchange="updateRecipeIngredient(${index}, 'quantity', parseFloat(this.value) || 0)"></td>
                    <td class="readonly">${ingredient.unit}</td>
                    <td class="readonly">$${Number(ingredient.cost).toFixed(2)}</td>
                    <td class="readonly">$${totalCost.toFixed(2)}</td>
                    <td><button class="btn btn-danger" onclick="deleteRecipeIngredient(${index})">Delete</button></td>
                `;
            });
            saveToStorage();
        }
        // </CHANGE>

        function addRecipeIngredient() {
            const recipe = recipes.find(r => r.id === currentRecipeId);
            if (!recipe) return;
            if (ingredients.length === 0) { alert('Please add ingredients first!'); return; }
            recipe.ingredients.push({ ingredientId: ingredients[0].id, quantity: 1 });
            renderRecipeIngredients();
            calculateRecipeCost();
        }

        function updateRecipeIngredient(index, field, value) {
            const recipe = recipes.find(r => r.id === currentRecipeId);
            recipe.ingredients[index][field] = field === 'quantity' ? (parseFloat(value) || 0) : value;
            renderRecipeIngredients();
            calculateRecipeCost();
        }

        function deleteRecipeIngredient(index) {
            const recipe = recipes.find(r => r.id === currentRecipeId);
            recipe.ingredients.splice(index, 1);
            renderRecipeIngredients();
            calculateRecipeCost();
        }

        function calculateRecipeCost() {
            const recipe = recipes.find(r => r.id === currentRecipeId);
            if (!recipe) return;
            let totalCost = 0;
            recipe.ingredients.forEach(recIng => {
                const ingredient = ingredients.find(i => i.id === recIng.ingredientId);
                if (ingredient) totalCost += (Number(recIng.quantity) || 0) * (Number(ingredient.cost) || 0);
            });
            document.getElementById('totalRecipeCost').textContent = `$${totalCost.toFixed(2)}`;
            document.getElementById('displayBatchSize').textContent = `${Number(recipe.batchSize) || 0} bbl`;
            const costPerBbl = (Number(recipe.batchSize) > 0) ? totalCost / Number(recipe.batchSize) : 0;
            document.getElementById('costPerBarrel').textContent = `$${costPerBbl.toFixed(2)}`;
        }

        function saveRecipe() {
            const recipe = recipes.find(r => r.id === currentRecipeId);
            recipe.name = document.getElementById('recipeName').value;
            recipe.style = document.getElementById('recipeStyle').value;
            recipe.batchSize = parseFloat(document.getElementById('batchSize').value) || 0;
            saveToStorage();
            calculateRecipeCost();
            updateRecipeSelectors();
            updateBatchRecipeSelector();
            updateSalesRecipeSelector();
            alert('Recipe saved!');
        }

        function deleteRecipe() {
            if (confirm('Delete this recipe?')) {
                recipes = recipes.filter(r => r.id !== currentRecipeId);
                saveToStorage();
                updateRecipeSelectors();
                updateBatchRecipeSelector();
                updateSalesRecipeSelector();
                document.getElementById('recipeEditor').style.display = 'none';
                document.getElementById('recipeSelector').value = '';
                currentRecipeId = null;
                renderBatches();
                renderMonthlyCOGS();
                renderSalesReport();
            }
        }

        // ======= BATCHES =======
        function updateBatchRecipeSelector() {
            const sel = document.getElementById('batchRecipe');
            if (!sel) return;
            const current = sel.value;
            sel.innerHTML = '<option value="">Select recipe...</option>';
            recipes.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r.id;
                opt.textContent = r.name;
                sel.appendChild(opt);
            });
            sel.value = current;
        }

        function getBatchFormData() {
            const data = {
                id: editingBatchId || Date.now(),
                date: document.getElementById('batchDate').value,
                recipeId: parseInt(document.getElementById('batchRecipe').value) || null,
                volumeRacked: parseFloat(document.getElementById('volumeRacked').value) || 0
            };
            return data;
        }

        function getRecipeCost(recipeId) {
            const recipe = recipes.find(r => r.id === recipeId);
            if (!recipe) return 0;
            let totalCost = 0;
            recipe.ingredients.forEach(recIng => {
                const ingredient = ingredients.find(i => i.id === recIng.ingredientId);
                if (ingredient) totalCost += (Number(recIng.quantity) || 0) * (Number(ingredient.cost) || 0);
            });
            return totalCost;
        }

        function batchTotals(b) {
            const recipe = recipes.find(r => r.id === b.recipeId);
            const recipeBatchSize = recipe ? (Number(recipe.batchSize) || 0) : 0;
            const yieldPct = recipeBatchSize > 0 ? (b.volumeRacked / recipeBatchSize) * 100 : 0;
            const recipeCost = getRecipeCost(b.recipeId);
            const costPerBBL = b.volumeRacked > 0 ? recipeCost / b.volumeRacked : 0;
            return { recipeBatchSize, yieldPct, costPerBBL };
        }

        function updateBatchKPIs() {
            const b = getBatchFormData();
            const totals = batchTotals(b);
            document.getElementById('kpiRecipeBatchSize').textContent = `${totals.recipeBatchSize.toFixed(2)} bbl`;
            document.getElementById('kpiYield').textContent = `${totals.yieldPct.toFixed(1)}%`;
            document.getElementById('kpiCostPerBBL').textContent = `$${totals.costPerBBL.toFixed(2)}`;
        }
        // </CHANGE>

        ['batchDate','batchRecipe','volumeRacked'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', updateBatchKPIs);
                el.addEventListener('change', updateBatchKPIs);
            }
        });

        function saveBatch() {
            const b = getBatchFormData();
            if (!b.date) { alert('Please select a date.'); return; }
            if (!b.recipeId) { alert('Please select a recipe.'); return; }
            if (!b.volumeRacked || b.volumeRacked <= 0) { alert('Please enter volume racked.'); return; }
            const idx = batches.findIndex(x => x.id === b.id);
            if (idx >= 0) { batches[idx] = b; } else { batches.push(b); }
            editingBatchId = null;
            saveToStorage();
            renderBatches();
            renderMonthlyCOGS();
            clearBatchForm();
            alert('Batch saved.');
        }

        function clearBatchForm() {
            editingBatchId = null;
            document.getElementById('batchDate').value = '';
            document.getElementById('batchRecipe').value = '';
            document.getElementById('volumeRacked').value = '';
            updateBatchKPIs();
        }

        function editBatch(id) {
            const b = batches.find(x => x.id === id);
            if (!b) return;
            editingBatchId = b.id;
            document.getElementById('batchDate').value = b.date;
            document.getElementById('batchRecipe').value = b.recipeId;
            document.getElementById('volumeRacked').value = b.volumeRacked;
            updateBatchKPIs();
            showTab('batches', document.querySelector('.tabs .tab:nth-child(3)'));
        }

        function deleteBatch(id) {
            if (!confirm('Delete this batch?')) return;
            batches = batches.filter(x => x.id !== id);
            saveToStorage();
            renderBatches();
            renderMonthlyCOGS();
        }

        function renderBatches() {
            const tbody = document.getElementById('batchTableBody');
            tbody.innerHTML = '';
            const sorted = [...batches].sort((a,b)=> (b.date||'').localeCompare(a.date||''));
            sorted.forEach(b => {
                const r = recipes.find(x => x.id === b.recipeId);
                const name = r ? r.name : '(deleted recipe)';
                const totals = batchTotals(b);
                const tr = tbody.insertRow();
                tr.innerHTML = `
                    <td>${b.date || ''}</td>
                    <td>${name}</td>
                    <td style="color: #495057; font-weight: 500;">${totals.recipeBatchSize.toFixed(2)}</td>
                    <td style="color: #495057; font-weight: 500;">${(b.volumeRacked||0).toFixed(2)}</td>
                    <td style="color: #495057; font-weight: 500;">${totals.yieldPct.toFixed(1)}%</td>
                    <td>$${totals.costPerBBL.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-primary" onclick="editBatch(${b.id})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteBatch(${b.id})">Delete</button>
                    </td>
                `;
            });
        }

        function setDefaultMonthPicker() {
            const mp = document.getElementById('monthPicker');
            if (!mp.value) {
                const d = new Date();
                const y = d.getFullYear();
                const m = String(d.getMonth()+1).padStart(2,'0');
                mp.value = `${y}-${m}`;
            }
        }

        function renderMonthlyCOGS() {
            const mp = document.getElementById('monthPicker');
            if (!mp.value) setDefaultMonthPicker();
            const [year, month] = mp.value.split('-').map(x=>parseInt(x));
            const tbody = document.getElementById('monthlyTableBody');
            tbody.innerHTML = '';
            let sumVolumeRacked = 0;
            let sumYieldPct = 0;
            let sumCostPerBBL = 0;
            let batchCount = 0;

            const filtered = batches.filter(b => {
                if (!b.date) return false;
                const d = new Date(b.date + 'T00:00:00');
                return (d.getFullYear() === year && (d.getMonth()+1) === month);
            }).sort((a,b)=> (a.date||'').localeCompare(b.date));

            filtered.forEach(b => {
                const totals = batchTotals(b);
                sumVolumeRacked += b.volumeRacked || 0;
                sumYieldPct += totals.yieldPct;
                sumCostPerBBL += totals.costPerBBL;
                batchCount++;
                const r = recipes.find(x => x.id === b.recipeId);
                const name = r ? r.name : '(deleted recipe)';
                const tr = tbody.insertRow();
                tr.innerHTML = `
                    <td>${b.date}</td>
                    <td>${name}</td>
                    <td style="color: #495057; font-weight: 500;">${totals.recipeBatchSize.toFixed(2)}</td>
                    <td style="color: #495057; font-weight: 500;">${(b.volumeRacked||0).toFixed(2)}</td>
                    <td style="color: #495057; font-weight: 500;">${totals.yieldPct.toFixed(1)}%</td>
                    <td>$${totals.costPerBBL.toFixed(2)}</td>
                `;
            });

            document.getElementById('mPackaged').textContent = (sumVolumeRacked || 0).toFixed(2);
            document.getElementById('mPackaged').style.color = '#495057';
            document.getElementById('mBatchCount').textContent = batchCount;
            document.getElementById('mBatchCount').style.color = '#495057';
            const avgYield = batchCount > 0 ? (sumYieldPct / batchCount) : 0;
            document.getElementById('mAvgYield').textContent = `${avgYield.toFixed(1)}%`;
            document.getElementById('mAvgYield').style.color = '#495057';
            const avgCostPerBBL = batchCount > 0 ? (sumCostPerBBL / batchCount) : 0;
            document.getElementById('mAvgCostPerBBL').textContent = `$${avgCostPerBBL.toFixed(2)}`;
        }
        // </CHANGE>

        // ======= SALES / MARGIN ANALYSIS =======
        function updateSalesRecipeSelector() {
            const sel = document.getElementById('salesRecipe');
            if (!sel) return;
            const current = sel.value;
            sel.innerHTML = '<option value="">Select recipe...</option>';
            recipes.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r.id;
                opt.textContent = r.name;
                sel.appendChild(opt);
            });
            sel.value = current;
        }

        function updateSalesKPIs() {
            const recipeId = parseInt(document.getElementById('salesRecipe').value);
            if (!recipeId) {
                ['16oz', '10oz', 'Pitcher', 'Growler'].forEach(size => {
                    document.getElementById(`cost${size}`).textContent = '$0.00';
                    document.getElementById(`profit${size}`).textContent = '$0.00';
                    document.getElementById(`margin${size}`).textContent = '0%';
                });
                document.getElementById('totalUnitsSold').textContent = '0';
                document.getElementById('totalRevenue').textContent = '$0.00';
                document.getElementById('totalCost').textContent = '$0.00';
                document.getElementById('grossProfit').textContent = '$0.00';
                document.getElementById('grossMargin').textContent = '0%';
                return;
            }

            const recipe = recipes.find(r => r.id === recipeId);
            const recipeCost = getRecipeCost(recipeId);
            const batchSizeOz = (Number(recipe.batchSize) || 0) * 31 * 128;

            let totalUnits = 0;
            let totalRevenue = 0;
            let totalCost = 0;

            const sizes = [
                { id: '16oz', oz: 16, name: '16oz' },
                { id: '10oz', oz: 10, name: '10oz' },
                { id: 'Pitcher', oz: 64, name: 'Pitcher' },
                { id: 'Growler', oz: 64, name: 'Growler' }
            ];

            sizes.forEach(size => {
                const unitsInput = document.getElementById(`units${size.id}`);
                const priceInput = document.getElementById(`price${size.id}`);
                const units = parseInt(unitsInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;

                const costPerUnit = batchSizeOz > 0 ? (recipeCost * size.oz) / batchSizeOz : 0;
                const revenue = units * price;
                const cost = units * costPerUnit;
                const profit = revenue - cost;
                const margin = revenue > 0 ? (profit / revenue) * 100 : 0;

                document.getElementById(`cost${size.id}`).textContent = `$${costPerUnit.toFixed(2)}`;
                document.getElementById(`profit${size.id}`).textContent = `$${profit.toFixed(2)}`;
                const marginEl = document.getElementById(`margin${size.id}`);
                marginEl.textContent = `${margin.toFixed(1)}%`;
                marginEl.style.color = '#495057';
                // </CHANGE>

                totalUnits += units;
                totalRevenue += revenue;
                totalCost += cost;
            });

            const grossProfit = totalRevenue - totalCost;
            const grossMargin = totalRevenue > 0 ? (grossProfit / totalRevenue) * 100 : 0;

            const totalUnitsEl = document.getElementById('totalUnitsSold');
            totalUnitsEl.textContent = totalUnits;
            totalUnitsEl.style.color = '#495057';
            // </CHANGE>
            
            document.getElementById('totalRevenue').textContent = `$${totalRevenue.toFixed(2)}`;
            document.getElementById('totalCost').textContent = `$${totalCost.toFixed(2)}`;
            document.getElementById('grossProfit').textContent = `$${grossProfit.toFixed(2)}`;
            
            const grossMarginEl = document.getElementById('grossMargin');
            grossMarginEl.textContent = `${grossMargin.toFixed(1)}%`;
            grossMarginEl.style.color = '#495057';
            // </CHANGE>
        }

        function saveSalesEntry() {
            const startDate = document.getElementById('salesStartDate').value;
            const endDate = document.getElementById('salesEndDate').value;
            const recipeId = parseInt(document.getElementById('salesRecipe').value);

            if (!startDate || !endDate) {
                alert('Please select start and end dates.');
                return;
            }
            if (!recipeId) {
                alert('Please select a recipe.');
                return;
            }

            const recipe = recipes.find(r => r.id === recipeId);
            const recipeCost = getRecipeCost(recipeId);
            const batchSizeOz = (Number(recipe.batchSize) || 0) * 31 * 128;

            const sizes = [
                { id: '16oz', oz: 16, name: '16oz' },
                { id: '10oz', oz: 10, name: '10oz' },
                { id: 'Pitcher', oz: 64, name: 'Pitcher' },
                { id: 'Growler', oz: 64, name: 'Growler' }
            ];

            let hasData = false;
            let tempSalesEntries = [];

            sizes.forEach(size => {
                const unitsInput = document.getElementById(`units${size.id}`);
                const priceInput = document.getElementById(`price${size.id}`);
                const units = parseInt(unitsInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;

                if (units > 0) {
                    hasData = true;
                    const costPerUnit = batchSizeOz > 0 ? (recipeCost * size.oz) / batchSizeOz : 0;
                    const revenue = units * price;
                    const cost = units * costPerUnit;
                    const profit = revenue - cost;
                    const margin = revenue > 0 ? (profit / revenue) * 100 : 0;

                    const entryId = editingSalesId || Date.now() + Math.random();
                    const entry = {
                        id: entryId,
                        startDate,
                        endDate,
                        recipeId,
                        size: size.name,
                        sizeOz: size.oz,
                        units,
                        pricePerUnit: price,
                        costPerUnit,
                        revenue,
                        cost,
                        profit,
                        margin
                    };
                    tempSalesEntries.push(entry);
                }
            });

            if (!hasData) {
                alert('Please enter at least one unit sold.');
                return;
            }

            if (editingSalesId) {
                salesEntries = salesEntries.filter(e => e.id !== editingSalesId);
            }

            salesEntries.push(...tempSalesEntries);

            saveToStorage();
            renderSalesReport();
            clearSalesForm();
            alert('Sales entry saved!');
        }

        function clearSalesForm() {
            editingSalesId = null;
            document.getElementById('salesStartDate').value = '';
            document.getElementById('salesEndDate').value = '';
            document.getElementById('salesRecipe').value = '';
            ['16oz', '10oz', 'Pitcher', 'Growler'].forEach(size => {
                document.getElementById(`units${size}`).value = '0';
                document.getElementById(`price${size}`).value = '0';
            });
            updateSalesKPIs();
        }

        function deleteSalesEntry(id) {
            if (!confirm('Delete this sales entry?')) return;
            salesEntries = salesEntries.filter(e => e.id !== id);
            saveToStorage();
            renderSalesReport();
        }

        function renderSalesReport() {
            const startDateInput = document.getElementById('reportStartDate');
            const endDateInput = document.getElementById('reportEndDate');
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;

            let filtered = salesEntries;
            if (startDate && endDate) {
                filtered = salesEntries.filter(e => {
                    return e.startDate >= startDate && e.endDate <= endDate;
                });
            } else if (startDate) {
                 filtered = salesEntries.filter(e => e.startDate >= startDate);
            } else if (endDate) {
                 filtered = salesEntries.filter(e => e.endDate <= endDate);
            }

            const tbody = document.getElementById('salesReportBody');
            tbody.innerHTML = '';

            let totalEntries = filtered.length;
            let totalUnits = 0;
            let totalRevenue = 0;
            let totalProfit = 0;

            const sorted = [...filtered].sort((a, b) => (a.startDate || '').localeCompare(b.startDate || ''));

            sorted.forEach(entry => {
                const recipe = recipes.find(r => r.id === entry.recipeId);
                const recipeName = recipe ? recipe.name : '(deleted recipe)';
                
                totalUnits += entry.units;
                totalRevenue += entry.revenue;
                totalProfit += entry.profit;

                const tr = tbody.insertRow();
                tr.innerHTML = `
                    <td>${entry.startDate} to ${entry.endDate}</td>
                    <td>${recipeName}</td>
                    <td>${entry.size}</td>
                    <td style="color: #495057; font-weight: 500;">${entry.units}</td>
                    <td>$${entry.pricePerUnit.toFixed(2)}</td>
                    <td>$${entry.revenue.toFixed(2)}</td>
                    <td>$${entry.profit.toFixed(2)}</td>
                    <td style="color: #495057; font-weight: 500;">${entry.margin.toFixed(1)}%</td>
                    <td>
                        <button class="btn btn-primary" onclick="editSalesEntry(${entry.id})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteSalesEntry(${entry.id})">Delete</button>
                    </td>
                `;
            });

            const avgMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;

            const reportEntriesEl = document.getElementById('reportEntries');
            reportEntriesEl.textContent = totalEntries;
            reportEntriesEl.style.color = '#495057';
            
            const reportUnitsEl = document.getElementById('reportUnits');
            reportUnitsEl.textContent = totalUnits;
            reportUnitsEl.style.color = '#495057';
            
            document.getElementById('reportRevenue').textContent = `$${totalRevenue.toFixed(2)}`;
            document.getElementById('reportProfit').textContent = `$${totalProfit.toFixed(2)}`;
            
            const reportMarginEl = document.getElementById('reportMargin');
            reportMarginEl.textContent = `${avgMargin.toFixed(1)}%`;
            reportMarginEl.style.color = '#495057';
        }
        // </CHANGE>

        function editSalesEntry(id) {
            const entry = salesEntries.find(e => e.id === id);
            if (!entry) return;

            editingSalesId = entry.id;
            document.getElementById('salesStartDate').value = entry.startDate;
            document.getElementById('salesEndDate').value = entry.endDate;
            document.getElementById('salesRecipe').value = entry.recipeId;
            
            const sizes = [
                { id: '16oz', oz: 16, name: '16oz' },
                { id: '10oz', oz: 10, name: '10oz' },
                { id: 'Pitcher', oz: 64, name: 'Pitcher' },
                { id: 'Growler', oz: 64, name: 'Growler' }
            ];

            sizes.forEach(size => {
                if (entry.size === size.name) {
                    document.getElementById(`units${size.id}`).value = entry.units;
                    document.getElementById(`price${size.id}`).value = entry.pricePerUnit.toFixed(2);
                } else {
                    document.getElementById(`units${size.id}`).value = '0';
                    document.getElementById(`price${size.id}`).value = '0';
                }
            });

            updateSalesKPIs();
            showTab('analysis', document.querySelector('.tabs .tab:nth-child(4)'));
        }

        // ======= INIT =======
        (function initDefaults(){
            const batchDateEl = document.getElementById('batchDate');
            if (batchDateEl && !batchDateEl.value) {
                const d = new Date();
                batchDateEl.value = d.toISOString().slice(0,10);
            }
            const salesStart = document.getElementById('salesStartDate');
            const salesEnd = document.getElementById('salesEndDate');
            if (salesStart && !salesStart.value) {
                const d = new Date();
                salesStart.value = d.toISOString().slice(0,10);
            }
            if (salesEnd && !salesEnd.value) {
                const d = new Date();
                salesEnd.value = d.toISOString().slice(0,10);
            }
        })();

        loadFromStorage();
    </script>
</body>
</html>
